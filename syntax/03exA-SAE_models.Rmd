---
title: "specific Model specification"
author: "Lorenz Alban Oehler"
output:
  html_document:
    theme: flatly      
    toc: true          
    toc_float: true    
    toc_depth: 4       
    highlight: tango   
    df_print: paged    
    css: styles.css 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



```{r message=FALSE, warning=FALSE}
# remove(list = ls())
### loading packages
library(haven)
library(reactable)
library(sf)
library(data.table)
library(saeTrafo)
library(emdi)
library(tidyverse)
```

# Introduction
In this script the SAE models FH and BHF will be calculated.   

The Variable selection resulted that we will use this Formula, for further specification of the Models.

aestudio ~ p26_edad + ocu_military + ocu_manager + 
    ocu_professional + ocu_technician + ocu_adminSupport + ocu_serviceSales + 
    ocu_agriculture + ocu_unskilled + sex_male + read_knowing + 
    urbrur_urban + health_insurance_yes + interior_plastered_yes + 
    v04_revoq_Missing + car_yes + water_heater_yes + kitchen_yes

# loading Data

```{r}
### auxillary data needed to calculate FH model
dat_census_aux <- readRDS("../data_raw/2024_census/processed/census_aux_data_aggregated.RDS")

#### load processed dummy coded census data
dat <- readRDS("../data_raw/2024_census/processed/dat_dummyCoding.RDS")
pop_table <- dat %>% group_by(ID_prov) %>% count()

#### load sample data
### 172 much better for FH
# sample <- readRDS("../data_raw/samples/transformed-2/sample_172.RDS")
sample <- readRDS("../data_raw/samples/sample_for_model_building_transformed.RDS")

sample %>% class()
sample <- sample %>% as.data.frame()

# FH full nutzt aggregated/shares aus dat_census_aux
fh_formula <- Mean ~ mean_p26_edad + share_ocu_military + share_ocu_manager + 
    share_ocu_professional + share_ocu_technician + share_ocu_adminSupport + 
  share_ocu_serviceSales + share_ocu_agriculture + share_ocu_unskilled + 
  share_sex_male + share_read_knowing + share_urbrur_urban + share_health_insurance_yes + 
  share_interior_plastered_yes + share_v04_revoq_Missing + share_car_yes + share_water_heater_yes + 
  share_kitchen_yes

# BHF nutzt individuelle Dummyvariablen im Sample/Census
bhf_formula <- aestudio ~ p26_edad + ocu_military + ocu_manager + 
    ocu_professional + ocu_technician + ocu_adminSupport + ocu_serviceSales + 
    ocu_agriculture + ocu_unskilled + sex_male + read_knowing + 
    urbrur_urban + health_insurance_yes + interior_plastered_yes + 
    v04_revoq_Missing + car_yes + water_heater_yes + kitchen_yes

sample$aestudio %>% hist()

```

# FH model

## combine data

### direct estimate of sample 

We have a simple random sample, which makes calculating the sample variance much easier, and we dont need second order inclusion criterion, nor do we need to use bootsrap or jacknife, to calculate the direct estimate and the domain specific variance. 

This is the HT estimator for the totls in a domain:$\hat{Y}_d = \sum_{i \in s_d} \frac{y_i}{\pi_i}$

This then is the resultig design-based variance: 
$$
\text{Var}_\pi(\hat{Y}_d) = \left(1 - \frac{n_d}{N_d}\right) \frac{N_d^2 S_d^2}{n_d}
$$

Now we are not interest in the totals, but in the variance of the mean, which results in this formula:
$$
\text{Var}_\pi(\bar{y}_d) = \frac{1}{N_d^2} \text{Var}_\pi(\hat{Y}_d) 
= \left(1 - \frac{n_d}{N_d}\right) \frac{S_d^2}{n_d}
$$



```{r}
# direct_estimates <- sample %>%
#   group_by(ID_prov) %>%
#   summarise(
#     Mean     = mean(aestudio, na.rm = TRUE),
#     n_eff    = sum(!is.na(aestudio)),
#     Var_Mean = var(aestudio, na.rm = T)/n_eff, #### we still have t inlcude FPC
#     .groups  = "drop"
#   )

sample <- sample %>% left_join(pop_table,by = "ID_prov")

direct_estimates <- sample %>%
  group_by(ID_prov) %>%
  reframe(
    Mean     = mean(aestudio, na.rm = TRUE),
    n_eff    = sum(!is.na(aestudio)),
    n = mean(n,na.rm = T),
    Var_Mean = (1 - (n_eff/n)) * var(aestudio, na.rm = T)/n_eff
  )

### recreate direct object
direct_rec <- list(
  "ind" = data.frame("Domain" = direct_estimates$ID_prov,
                     "Mean" = direct_estimates$Mean),
  "MSE" = data.frame("Domain" = direct_estimates$ID_prov,
                     "Mean" = direct_estimates$Var_Mean)
)
class(direct_rec) <- c("direct", "emdi")

# direct_rec %>% class()
# direct %>% class()


# direct <- emdi::direct(y = "aestudio", smp_data = sample ,smp_domains = "ID_prov",var = T,na.rm = T,B = 500)
# saveRDS(direct,"../data_raw/simulation/processed/direct_500_bootstraps.RDS")
direct <- readRDS("../data_raw/simulation/processed/direct_500_bootstraps.RDS")

# tmp_dat <- merge(direct$MSE[,c("Domain","Mean")],direct_estimates[,c("ID_prov","Var_Mean")],by.x = "Domain", by.y = "ID_prov")
# plot(tmp_dat$Mean,tmp_dat$Var_Mean)
# direct$successful_bootstraps

# cor.test(tmp_dat$Mean,tmp_dat$Var_Mean)
```

### combine with auxillary data

```{r}
combined_data <- merge(direct_estimates,dat_census_aux,by = "ID_prov")
```

## FH Models
### FH null model

```{r}
fh_model_null <- fh(
fixed = Mean ~ 1,
vardir = "Var_Mean",
combined_data = combined_data,
domains = "ID_prov",
method = "reml",
MSE = TRUE
)

fh_model_null$MSE$FH %>% mean()
```

### FH full model 

```{r}
###  ml, becasue step funcion only works with ml 
fh_model_full_step <- fh(
fixed = fh_formula,
vardir = "Var_Mean",
combined_data = combined_data,
domains = "ID_prov",
method = "ml",
MSE = TRUE
)

fh_model_full_unoptimized <- fh(
fixed = fh_formula,
vardir = "Var_Mean",
combined_data = combined_data,
domains = "ID_prov",
method = "reml",
MSE = TRUE
)

fh_model_full_unoptimized$MSE$FH %>% mean()
# (sqrt(fh_model_full$MSE$FH)/fh_model_full$ind$FH * 100) %>% mean()
```
### FH step function

```{r}
### model selection
emdi::step(fh_model_full_step,direction ="both")
fh_formula_optimized <- Mean ~ mean_p26_edad + share_ocu_professional + share_ocu_technician +
    share_ocu_adminSupport + share_ocu_serviceSales + share_sex_male +
    share_read_knowing + share_urbrur_urban + share_health_insurance_yes +
    share_v04_revoq_Missing + share_car_yes + share_kitchen_yes


### which is the optimized one
fh_model_full <- fh(fixed = fh_formula_optimized,
    vardir = "Var_Mean", combined_data = combined_data, domains = "ID_prov",
    method = "reml", MSE = TRUE)

fh_model_full$MSE$FH %>% mean()
# step(fh_model_full,direction ="backward",criteria = "BIC")

```


### FH dignostics 
```{r}
p_dig_FH <- plot(fh_model_full)
p_dig_FH_comp <- emdi::compare_plot(model = fh_model_full,direct = direct_estimates,MSE = T,CV = T)

p_dig_FH
p_dig_FH_comp
```

# log FH
```{r}

fh_model_full_log <- fh(
fixed = fh_formula,
vardir = "Var_Mean",
combined_data = combined_data,
domains = "ID_prov",
method = "reml",transformation = "log",backtransformation = "bc_crude",
MSE = TRUE
)

plot(fh_model_full_log)
fh_model_full_log$MSE$FH %>% mean()
```



# BHF model
## process data 

```{r}
### create vector with sizo of domains
vec_pop_size <- table(dat$ID_prov)

nrow(dat)
dat_BHF_census <- dat[!is.na(dat$aestudio),]
nrow(dat_BHF_census)
dat_BHF_census <- na.omit(dat_BHF_census)
nrow(dat_BHF_census)
dat_BHF_census$ID_prov <- dat_BHF_census$ID_prov %>% as.factor()
# sapply(dat_BHF_census,FUN = function(x) sum(is.na(x)))

nrow(sample)
dat_BHF_sample <- sample[!is.na(sample$aestudio),]
nrow(dat_BHF_sample)
dat_BHF_sample <- na.omit(dat_BHF_sample)
nrow(dat_BHF_sample)
dat_BHF_sample$ID_prov <- dat_BHF_sample$ID_prov %>% as.factor()
sapply(dat_BHF_sample,FUN = function(x) sum(is.na(x)))
```
## BHF Model

```{r}
BHF_model_full_unoptimized <-  NER_Trafo(fixed = bhf_formula
  ,smp_domains = "ID_prov"
  , smp_data = dat_BHF_sample
  , pop_data = dat_BHF_census
  , pop_area_size = vec_pop_size
  , pop_domains = "ID_prov"
  , transformation = "no"
  , seed = 2022
  , MSE = T
)

BHF_model_full_unoptimized$MSE$Mean %>% mean()
```

## step function with intercept

```{r}
library(lmerTest)
### model selection
full_model <- lm(bhf_formula,data = sample)
bhf_formula_intercept <- aestudio ~ p26_edad + ocu_military + ocu_manager + ocu_professional + 
    ocu_technician + ocu_adminSupport + ocu_serviceSales + ocu_agriculture + 
    ocu_unskilled + sex_male + read_knowing + urbrur_urban + 
    health_insurance_yes + interior_plastered_yes + v04_revoq_Missing + 
    car_yes + water_heater_yes + kitchen_yes + (1|ID_prov)

lmer_model <- lmer(bhf_formula_intercept,data = sample)
# lmer_model %>% summary()

step(lmer_model)
```

Suggested model by step funktion
bhf_formula_optimized <-  aestudio ~ p26_edad + ocu_military + ocu_manager + ocu_professional + ocu_technician + ocu_adminSupport + ocu_serviceSales + ocu_agriculture + ocu_unskilled + sex_male + read_knowing + urbrur_urban + health_insurance_yes + interior_plastered_yes + car_yes + water_heater_yes + kitchen_yes + (1 | ID_prov)

```{r}
bhf_formula_optimized <-  aestudio ~ p26_edad + ocu_military + ocu_manager + ocu_professional + ocu_technician + ocu_adminSupport + ocu_serviceSales + ocu_agriculture + ocu_unskilled + sex_male + read_knowing + urbrur_urban + health_insurance_yes + interior_plastered_yes + car_yes + water_heater_yes + kitchen_yes

BHF_model_full <-  NER_Trafo(fixed = bhf_formula_optimized
  ,smp_domains = "ID_prov"
  , smp_data = dat_BHF_sample
  , pop_data = dat_BHF_census
  , pop_area_size = vec_pop_size
  , pop_domains = "ID_prov"
  , transformation = "no"
  , seed = 2022
  , MSE = T
)

BHF_model_full$MSE$Mean %>% mean()
```


## diagnostics 

```{r}
p_dig_BHF <- plot(BHF_model_full)
p_dig_BHF_comp <- saeTrafo::compare_plot(model = BHF_model_full,direct = direct,MSE = T,CV = T)
```

# pretty diagnostics

## FH

```{r}
library(cowplot)

p1 <- p_dig_FH$density_res

p2 <- p_dig_FH$density_res +
  # scale_color_manual(values = c("red")) +
  # scale_fill_manual(values = c("red")) +
  geom_density(color = "#FF8552",fill = "#FF8552",alpha = .15, linewidth = .4) +
   # geom_hline(yintercept = 0, linetype = "dashed", color = "grey40") +
  theme_minimal() +
    labs(
    title = "FH - Residual Assumption",
    # subtitle = "Fay–Herriot model",
    x = "standardized Residuals",
    y = "Density",
    # caption = "Source: household survey + census"
  )

p3 <- p_dig_FH$density_ran

p4 <- p_dig_FH$density_ran +
  # scale_color_manual(values = c("red")) +
  # scale_fill_manual(values = c("red")) +
  geom_density(color = "#FF8552",fill = "#FF8552",alpha = .15, linewidth = .4) +
   # geom_hline(yintercept = 0, linetype = "dashed", color = "grey40") +
  theme_minimal() +
    labs(
    title = "FH - Randome Effects Assumption",
    # subtitle = "Fay–Herriot model",
    x = "standardized randome effects",
    y = "Density",
    # caption = "Source: household survey + census"
  )

plot_grid(p1,p2,p3,p4,nrow = 2,ncol = 2)
```

```{r}
p5 <- p_dig_FH_comp$scatter_FH

p6 <- p_dig_FH_comp$scatter_FH +
  geom_smooth(aes(color = "Reg. line"), method = "lm", se = FALSE) +
  scale_color_manual(values = c("Reg. line" = "#9A031E", "Intersection" = "#FF8552")) +
  theme_minimal() +
  labs(
    title = "direct vs fh estimates",
    x = "direct",
    y = "fh-model",
    color = ""
  )

p7 <- p_dig_FH_comp$line_FH

p8 <- p_dig_FH_comp$line_FH +
  # Override layer colors to be mapped instead of fixed
  # geom_line(aes(color = c("Direct", "Model-based"))) +
  # geom_line(size = .8,alpha = .3) +
  # geom_point(size = 1, alpha = .5) +
  scale_color_manual(values = c("#9A031E","#FF8552")) +
  theme_minimal() +
  labs(
    title = "Direct vs FH estimates ordered by Domain size",
    x = "Domain - ordered by decreasing MSE of Direct",
    y = "mean years of schooling estimate",
    color = "Method"
  )

p9 <- p_dig_FH_comp$ordered_MSE_FH

p10 <- p_dig_FH_comp$ordered_MSE_FH +
  scale_color_manual(values = c("#9A031E","#FF8552")) +
  theme_minimal() +
    labs(
    title = "MSE: direct vs FH",
    # subtitle = "Fay–Herriot model",
    x = "Domain - ordered by increasing MSE of Direct",
    y = "MSE",
    # caption = "Source: household survey + census"
  )


plot_grid(p5,p6,p7,p8,p9,p10,nrow = 3,ncol = 2)
```

```{r fig.width=6, fig.height=16}
plot_grid_fh <- plot_grid(p2,p4,p8,p10,nrow = 4)
plot_grid_fh

ggsave("../output/diagnostics_fh.svg",
       plot = plot_grid_fh,
       width = 6,      # width in inches
       height = 16,    # height in inches; make it long enough for 5 plots
       units = "in",   # units for width/height
       device = "svg")

ggsave("../output/diagnostics_fh.png", 
       plot = plot_grid_fh,
       width = 6,      # width in inches
       height = 16,    # height in inches; make it long enough for 5 plots
       units = "in",   # units for width/height
       dpi = 300)

```

## BHF

```{r}
p1 <- p_dig_BHF$density_res

p2 <- p_dig_BHF$density_res +
  # scale_color_manual(values = c("red")) +
  # scale_fill_manual(values = c("red")) +
  geom_density(color = "#7ca982",fill = "#7ca982",alpha = .15, linewidth = .4) +
   # geom_hline(yintercept = 0, linetype = "dashed", color = "grey40") +
  theme_minimal() +
    labs(
    title = "BHF - Residual Assumption",
    # subtitle = "Fay–Herriot model",
    x = "standardized Residuals",
    y = "Density",
    # caption = "Source: household survey + census"
  )

p3 <- p_dig_BHF$density_ran

p4 <- p_dig_FH$density_ran +
  # scale_color_manual(values = c("red")) +
  # scale_fill_manual(values = c("red")) +
  geom_density(color = "#7ca982",fill = "#7ca982",alpha = .15, linewidth = .4) +
   # geom_hline(yintercept = 0, linetype = "dashed", color = "grey40") +
  theme_minimal() +
    labs(
    title = "BHF - Randome Effects Adsumption",
    # subtitle = "Fay–Herriot model",
    x = "standardized randome effects",
    y = "Desnity",
    # caption = "Source: household survey + census"
  )

plot_grid(p1,p2,p3,p4,nrow = 2,ncol = 2)
```

```{r}
p5 <- p_dig_BHF_comp$scatter_Mean

p6 <- p_dig_BHF_comp$scatter_Mean +
  geom_smooth(aes(color = "Reg. line"), method = "lm", se = FALSE) +
  scale_color_manual(values = c("Reg. line" = "#4e6b57", "Intersection" = "#b5c5b4")) +
  theme_minimal() +
  labs(
    title = "direct vs BHF estimates",
    x = "direct",
    y = "BHF-Mode",
    color = ""
  )

p7 <- p_dig_BHF_comp$line_Mean

p8 <- p_dig_BHF_comp$line_Mean +
  # Override layer colors to be mapped instead of fixed
  # geom_line(aes(color = c("Direct", "Model-based"))) +
  # geom_line(aes(size = .8,alpha = .3)) +
  # geom_point(aes(size = 1, alpha = .2)) +
  scale_color_manual(values = c("#4e6b57","#b5c5b4")) +
  theme_minimal() +
  labs(
    title = "Direct vs BHF estimates ordered by Domain size",
    x = "Domain - ordered by decreasing MSE of direct estimation",
    y = "mean years of schooling estimate",
    color = "Method"
  )

p9 <- p_dig_BHF_comp$ordered_MSE_Mean

p10 <- p_dig_BHF_comp$ordered_MSE_Mean +
  scale_color_manual(values = c("#4e6b57","#b5c5b4")) +
  theme_minimal() +
    labs(
    title = "MSE: direct vs BHF",
    # subtitle = "Fay–Herriot model",
    x = "Domain - ordered by increasing MSE of direct estimation",
    y = "MSE",
    # caption = "Source: household survey + census"
  )

plot_grid(p5,p6,p7,p8,p9,p10,nrow = 3,ncol = 2)
```


```{r fig.width=6, fig.height=16}
plot_grid_bhf <- plot_grid(p2,p4,p8,p10,nrow = 5)
plot_grid_bhf

ggsave("../output/diagnostics_bhf.svg", 
       plot = plot_grid_bhf,
       width = 6,      # width in inches
       height = 16,    # height in inches; make it long enough for 5 plots
       units = "in",   # units for width/height
       device = "svg")

ggsave("../output/disgnostics_bhf.png", 
       plot = plot_grid_bhf,
       width = 6,      # width in inches
       height = 16,    # height in inches; make it long enough for 5 plots
       units = "in",   # units for width/height
       dpi = 300)

```


```{r}
# fh_model_full$MSE$Direct %>% mean()
# fh_model_full$MSE$FH %>% mean()
# BHF_model_full$MSE$Mean %>% mean()
```



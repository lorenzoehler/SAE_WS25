---
title: "Template Title"
author: "Lorenz Alban Oehler"
date: "The Date"
output:
  html_document:
    theme: flatly      
    toc: true          
    toc_float: true    
    toc_depth: 4       
    highlight: tango   
    df_print: paged    
    css: styles.css 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



```{r setup, include=FALSE}
### loading packages
library(haven)
library(reactable)
library(sf)
library(data.table)
library(saeTrafo)
library(emdi)
library(tidyverse)
```

# Introduction
In this script the SAE models FH and BHF will be calculated.   
The formulat for the estimation which we will use is: 

aestudio ~ p26_edad + ocu_military + ocu_manager + ocu_professional + ocu_technician + ocu_adminSupport + ocu_serviceSales + ocu_agriculture + ocu_construction + ocu_operators + ocu_unskilled + ocu_NaN + ocu_1d_13_REST + sex_female + read_knowing + urbrur_urban

# loading Data

```{r}
### auxillary data needed to calculate FH model
dat_census_aux <- readRDS("../../data_raw/2024_census/processed/census_aux_data_aggregated.RDS")

#### load processed dummy coded census data
dat <- readRDS("../../data_raw/2024_census/processed/dat_dummyCoding.RDS")

#### load sample data
sample <- readRDS("../../data_raw/samples/sample_for_model_building_transformed.RDS")
```

# FH model

## combine data

### direct estimate of sample 

```{r}
direct_estimates <- sample %>%
  group_by(ID_prov) %>% 
  summarise(
    Mean     = mean(aestudio, na.rm = TRUE), 
    n_eff    = sum(!is.na(aestudio)), 
    Var_Mean = var(aestudio, na.rm = T)/n_eff,
    .groups  = "drop"
  )
```

### combine with auxillary data

```{r}
combined_data <- merge(direct_estimates,dat_census_aux,by = "ID_prov")
```

### FH null model

```{r}
fh_model_null <- fh(
fixed = Mean ~ 1,
vardir = "Var_Mean",
combined_data = combined_data,
domains = "ID_prov",
method = "reml",
MSE = TRUE
)

fh_model_null$MSE$FH %>% mean()
```

### FH full model 
```{r}
fh_model_full <- fh(
fixed = Mean ~ mean_p26_edad + share_ocu_military + share_ocu_manager + share_ocu_professional + share_ocu_technician + share_ocu_adminSupport + share_ocu_serviceSales + share_ocu_agriculture + share_ocu_construction + share_ocu_operators + share_ocu_unskilled + share_ocu_NaN  + share_sex_female + share_read_knowing + share_urbrur_urban,
vardir = "Var_Mean",
combined_data = combined_data,
domains = "ID_prov",
method = "reml",
MSE = TRUE
)

fh_model_full$MSE$FH %>% mean()
```

# BHF model
```{r}
### create vector with sizo of domains
vec_pop_size <- table(dat$ID_prov)

dat_BHF_census <- dat[!is.na(dat$aestudio),]
dat_BHF_census <- na.omit(dat_BHF_census)
dat_BHF_census$ID_prov <- dat_BHF_census$ID_prov %>% as.factor()
sapply(dat_BHF_census,FUN = function(x) sum(is.na(x)))

dat_BHF_sample <- sample[!is.na(sample$aestudio),]
dat_BHF_sample <- na.omit(dat_BHF_sample)
dat_BHF_sample$ID_prov <- dat_BHF_sample$ID_prov %>% as.factor()
sapply(dat_BHF_sample,FUN = function(x) sum(is.na(x)))
```

```{r}
BHF_model_complex <-  NER_Trafo(fixed = aestudio ~ p26_edad 
  + ocu_military + ocu_manager + ocu_professional + ocu_technician 
  + ocu_adminSupport + ocu_serviceSales + ocu_agriculture + ocu_construction 
  + ocu_operators + ocu_unskilled + ocu_NaN + sex_female 
  + read_knowing + urbrur_urban
  ,smp_domains = "ID_prov"
  , smp_data = dat_BHF_sample
  , pop_data = dat_BHF_census
  , pop_area_size = vec_pop_size
  , pop_domains = "ID_prov"
  , transformation = "no"
  , seed = 2022
  , MSE = T
)

BHF_model_complex$MSE$Mean %>% mean()
```



---
title: "Template Title"
author: "Lorenz Alban Oehler"
date: "The Date"
output:
  html_document:
    theme: flatly      
    toc: true          
    toc_float: true    
    toc_depth: 4       
    highlight: tango   
    df_print: paged    
    css: styles.css 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



```{r setup, include=FALSE}
### loading packages
library(haven)
library(reactable)
library(sf)
library(data.table)
library(saeTrafo)
library(emdi)
library(tidyverse)
```

# Introduction
In this script the SAE models FH and BHF will be calculated.   
The formulat for the estimation which we will use is: 

aestudio ~ p26_edad + ocu_military + ocu_professional + ocu_technician + ocu_adminSupport + ocu_construction +ocu_operators + ocu_NaN + read_knowing + urbrur_urban

# loading Data

```{r}
### auxillary data needed to calculate FH model
dat_census_aux <- readRDS("../../data_raw/2024_census/processed/census_aux_data_aggregated.RDS")

#### load processed dummy coded census data
dat <- readRDS("../../data_raw/2024_census/processed/dat_dummyCoding.RDS")
pop_table <- dat %>% group_by(ID_prov) %>% count()

#### load sample data
# sample <- readRDS("../../data_raw/samples/transformed/sample_001.RDS")
sample <- readRDS("../../data_raw/samples/sample_for_model_building_transformed.RDS")

sample %>% class()
sample <- sample %>% as.data.frame()

# FH full nutzt aggregated/shares aus dat_census_aux
fh_formula <- Mean ~ mean_p26_edad + share_ocu_military +
  share_ocu_professional + share_ocu_adminSupport + share_ocu_construction +
  share_ocu_operators + share_ocu_NaN + share_read_knowing + share_urbrur_urban

# BHF nutzt individuelle Dummyvariablen im Sample/Census
bhf_formula <- aestudio ~ p26_edad + ocu_military + ocu_professional + 
    ocu_technician + ocu_adminSupport + ocu_construction +
    ocu_operators + ocu_NaN + read_knowing + urbrur_urban

```

# FH model

## combine data

### direct estimate of sample 

We have a simple random sample, which makes calculating the sample variance much easier, and we dont need second order inclusion criterion, nor do we need to use bootsrap or jacknife, to calculate the direct estimate and the domain specific variance. 

This is the HT estimator for the totls in a domain:$\hat{Y}_d = \sum_{i \in s_d} \frac{y_i}{\pi_i}$

This then is the resultig design-based variance: 
$$
\text{Var}_\pi(\hat{Y}_d) = \left(1 - \frac{n_d}{N_d}\right) \frac{N_d^2 S_d^2}{n_d}
$$

Now we are not interest in the totals, but in the variance of the mean, which results in this formula:
$$
\text{Var}_\pi(\bar{y}_d) = \frac{1}{N_d^2} \text{Var}_\pi(\hat{Y}_d) 
= \left(1 - \frac{n_d}{N_d}\right) \frac{S_d^2}{n_d}
$$



```{r}
# direct_estimates <- sample %>%
#   group_by(ID_prov) %>%
#   summarise(
#     Mean     = mean(aestudio, na.rm = TRUE),
#     n_eff    = sum(!is.na(aestudio)),
#     Var_Mean = var(aestudio, na.rm = T)/n_eff, #### we still have t inlcude FPC
#     .groups  = "drop"
#   )

sample <- sample %>% left_join(pop_table,by = "ID_prov")

direct_estimates <- sample %>%
  group_by(ID_prov) %>%
  reframe(
    Mean     = mean(aestudio, na.rm = TRUE),
    n_eff    = sum(!is.na(aestudio)),
    n = mean(n,na.rm = T),
    Var_Mean = (1 - (n_eff/n)) * var(aestudio, na.rm = T)/n_eff
  )

### recreate direct object
direct_rec <- list(
  "ind" = data.frame("Domain" = direct_estimates$ID_prov,
                     "Mean" = direct_estimates$Mean),
  "MSE" = data.frame("Domain" = direct_estimates$ID_prov,
                     "Mean" = direct_estimates$Var_Mean)
)
class(direct_rec) <- c("direct", "emdi")

# direct_rec %>% class()
# direct %>% class()


# direct <- emdi::direct(y = "aestudio", smp_data = sample ,smp_domains = "ID_prov",var = T,na.rm = T,B = 500)
# saveRDS(direct,"../../data_raw/simulation/processed/direct_500_bootstraps.RDS")
direct <- readRDS("../../data_raw/simulation/processed/direct_500_bootstraps.RDS")

# tmp_dat <- merge(direct$MSE[,c("Domain","Mean")],direct_estimates[,c("ID_prov","Var_Mean")],by.x = "Domain", by.y = "ID_prov")
# plot(tmp_dat$Mean,tmp_dat$Var_Mean)
# direct$successful_bootstraps

# cor.test(tmp_dat$Mean,tmp_dat$Var_Mean)
```

### combine with auxillary data

```{r}
combined_data <- merge(direct_estimates,dat_census_aux,by = "ID_prov")
```

### FH null model

```{r}
fh_model_null <- fh(
fixed = Mean ~ 1,
vardir = "Var_Mean",
combined_data = combined_data,
domains = "ID_prov",
method = "reml",
MSE = TRUE
)

fh_model_null$MSE$FH %>% mean()
```

### FH full model 
```{r}
fh_model_full <- fh(
fixed = fh_formula,
vardir = "Var_Mean",
combined_data = combined_data,
domains = "ID_prov",
method = "ml",
MSE = TRUE
)

fh_model_full$MSE$FH %>% mean()
(sqrt(fh_model_full$MSE$FH)/fh_model_full$ind$FH * 100) %>% mean()
```


```{r}
### model seleciton
# step(fh_model_full,direction ="backward",criteria = "AIC")
# step(fh_model_full,direction ="backward",criteria = "BIC")

```

```{r}
# fh(fixed =Mean ~ share_ocu_professional + share_read_knowing, 
#     vardir = "Var_Mean", combined_data = combined_data, domains = "ID_prov", 
#     method = "ml", MSE = TRUE)

# lm(formula = aestudio ~ ocu_professional + read_knowing,data = sample) %>% summary()
# 
model <-  lm(formula = aestudio ~ p26_edad + ocu_military + ocu_professional +ocu_technician + ocu_adminSupport + ocu_construction + ocu_operators + ocu_NaN +  read_knowing + urbrur_urban, data = sample)

stats::step(model,direction = "both")

```

### FH dignostics 
```{r}
p_dig_FH <- plot(fh_model_full)
p_dig_FH_comp <- compare_plot(model = fh_model_full,direct = direct_estimates,MSE = T,CV = T)

p_dig_FH
p_dig_FH_comp
```




# BHF model
```{r}
### create vector with sizo of domains
vec_pop_size <- table(dat$ID_prov)

dat_BHF_census <- dat[!is.na(dat$aestudio),]
dat_BHF_census <- na.omit(dat_BHF_census)
dat_BHF_census$ID_prov <- dat_BHF_census$ID_prov %>% as.factor()
sapply(dat_BHF_census,FUN = function(x) sum(is.na(x)))

dat_BHF_sample <- sample[!is.na(sample$aestudio),]
dat_BHF_sample <- na.omit(dat_BHF_sample)
dat_BHF_sample$ID_prov <- dat_BHF_sample$ID_prov %>% as.factor()
sapply(dat_BHF_sample,FUN = function(x) sum(is.na(x)))
```


```{r}
BHF_model_full <-  NER_Trafo(fixed = bhf_formula
  ,smp_domains = "ID_prov"
  , smp_data = dat_BHF_sample
  , pop_data = dat_BHF_census
  , pop_area_size = vec_pop_size
  , pop_domains = "ID_prov"
  , transformation = "no"
  , seed = 2022
  , MSE = T
)


# step(BHF_model_full)
# sapply(sample,function(x)  var(x))
BHF_model_full$MSE$Mean %>% mean()
```

```{r}
### model selection
# full_model <- lm(aestudio ~ p26_edad + ocu_military + ocu_professional + 
    # ocu_technician + ocu_adminSupport + ocu_construction + ocu_operators + 
    # ocu_NaN + read_knowing,data = sample)

# stats::step(full_model,direction = "backward",k = 2) ### is AIC
# stats::step(full_model,direction = "backward",k = log(nrow(sample))) ### is BIC
library(lmerTest)

lmer_model <- lmer(aestudio ~ p26_edad + ocu_military + ocu_professional +
    ocu_technician + ocu_adminSupport + ocu_construction + ocu_operators +
    ocu_NaN + read_knowing + (1|ID_prov),data = sample)

# lmer_model %>% summary()

step(lmer_model)

### suggested model
# lmer_model <- lmer(aestudio ~ p26_edad + ocu_professional + ocu_technician + 
#        ocu_adminSupport + ocu_operators + ocu_NaN + read_knowing + 
#        (1 | ID_prov),data = sample) %>% summary()


```


## diagnostics 

```{r}
p_dig_BHF <- plot(BHF_model_full)
p_dig_BHF_comp <- saeTrafo::compare_plot(model = BHF_model_full,direct = direct,MSE = T,CV = T)
```

### step
```{r}
model_step <- lm(aestudio ~ p26_edad + ocu_military + ocu_professional + 
    ocu_technician + ocu_adminSupport + ocu_construction +
    ocu_operators + ocu_NaN + read_knowing + urbrur_urban, dat_BHF_sample) 

stats::step(model_step,direction = "both",k = log(nrow(sample)))
stats::step(model_step,direction = "both",k = 2)
```
### pretty diagnostics

#### FH

```{r}
library(cowplot)

p1 <- p_dig_FH$density_res

p2 <- p_dig_FH$density_res +
  # scale_color_manual(values = c("red")) +
  # scale_fill_manual(values = c("red")) +
  geom_density(color = "red",fill = "red",alpha = .15, linewidth = .4) +
   # geom_hline(yintercept = 0, linetype = "dashed", color = "grey40") +
  theme_minimal() +
    labs(
    title = "Density plot - standardized Residuals",
    # subtitle = "Fay–Herriot model",
    x = "standardized Residuals",
    y = "Density",
    # caption = "Source: household survey + census"
  )

p3 <- p_dig_FH$density_ran

p4 <- p_dig_FH$density_ran +
  # scale_color_manual(values = c("red")) +
  # scale_fill_manual(values = c("red")) +
  geom_density(color = "red",fill = "red",alpha = .15, linewidth = .4) +
   # geom_hline(yintercept = 0, linetype = "dashed", color = "grey40") +
  theme_minimal() +
    labs(
    title = "Density plot - randome Effects",
    # subtitle = "Fay–Herriot model",
    x = "randome effects",
    y = "Desnity",
    # caption = "Source: household survey + census"
  )

plot_grid(p1,p2,p3,p4,nrow = 2,ncol = 2)
```

```{r}
p1 <- p_dig_FH_comp$scatter_FH

p2 <- p_dig_FH_comp$scatter_FH +
  geom_smooth(aes(color = "Reg. line"), method = "lm", se = FALSE) +
  scale_color_manual(values = c("Reg. line" = "red", "Intersection" = "orange")) +
  theme_minimal() +
  labs(
    title = "Density plot - standardized Residuals",
    x = "standardized Residuals",
    y = "Density",
    color = ""
  )

p3 <- p_dig_FH_comp$line_FH

p4 <- p_dig_FH_comp$line_FH +
  # Override layer colors to be mapped instead of fixed
  # geom_line(aes(color = c("Direct", "Model-based"))) +
  geom_line(size = 1,alpha = .3) +
  geom_point(size = 2) +
  scale_color_manual(values = c("red","orange")) +
  theme_minimal() +
  labs(
    title = "Density plot - Random Effects",
    x = "Random effects",
    y = "Density",
    color = "Method"
  )

p5 <- p_dig_FH_comp$ordered_CV_FH

p6 <- p_dig_FH_comp$ordered_CV_FH +
  scale_color_manual(values = c("red","orange")) +
  theme_minimal() +
    labs(
    title = "Density plot - randome Effects",
    # subtitle = "Fay–Herriot model",
    x = "randome effects",
    y = "Desnity",
    # caption = "Source: household survey + census"
  )

p6



plot_grid(p1,p2,p3,p4,p5,p6,nrow = 3,ncol = 2)
```
#### BHF

```{r}
p1 <- p_dig_BHF$density_res

p2 <- p_dig_BHF$density_res +
  # scale_color_manual(values = c("red")) +
  # scale_fill_manual(values = c("red")) +
  geom_density(color = "#7ca982",fill = "#7ca982",alpha = .15, linewidth = .4) +
   # geom_hline(yintercept = 0, linetype = "dashed", color = "grey40") +
  theme_minimal() +
    labs(
    title = "Density plot - standardized Residuals",
    # subtitle = "Fay–Herriot model",
    x = "standardized Residuals",
    y = "Density",
    # caption = "Source: household survey + census"
  )

p3 <- p_dig_BHF$density_ran

p4 <- p_dig_FH$density_ran +
  # scale_color_manual(values = c("red")) +
  # scale_fill_manual(values = c("red")) +
  geom_density(color = "#7ca982",fill = "#7ca982",alpha = .15, linewidth = .4) +
   # geom_hline(yintercept = 0, linetype = "dashed", color = "grey40") +
  theme_minimal() +
    labs(
    title = "Density plot - randome Effects",
    # subtitle = "Fay–Herriot model",
    x = "randome effects",
    y = "Desnity",
    # caption = "Source: household survey + census"
  )

plot_grid(p1,p2,p3,p4,nrow = 2,ncol = 2)
```

```{r}
p1 <- p_dig_BHF_comp$scatter_Mean

p2 <- p_dig_BHF_comp$scatter_Mean +
  geom_smooth(aes(color = "Reg. line"), method = "lm", se = FALSE) +
  scale_color_manual(values = c("Reg. line" = "#4e6b57", "Intersection" = "#b5c5b4")) +
  theme_minimal() +
  labs(
    title = "Density plot - standardized Residuals",
    x = "standardized Residuals",
    y = "Density",
    color = ""
  )

p3 <- p_dig_BHF_comp$line_Mean

p4 <- p_dig_BHF_comp$line_Mean +
  # Override layer colors to be mapped instead of fixed
  # geom_line(aes(color = c("Direct", "Model-based"))) +
  geom_line(size = 1,alpha = .3) +
  geom_point(size = 2) +
  scale_color_manual(values = c("#4e6b57","#b5c5b4")) +
  theme_minimal() +
  labs(
    title = "Density plot - Random Effects",
    x = "Random effects",
    y = "Density",
    color = "Method"
  )

p5 <- p_dig_BHF_comp$ordered_CV_Mean

p6 <- p_dig_BHF_comp$ordered_CV_Mean +
  scale_color_manual(values = c("#4e6b57","#b5c5b4")) +
  theme_minimal() +
    labs(
    title = "Density plot - randome Effects",
    # subtitle = "Fay–Herriot model",
    x = "randome effects",
    y = "Desnity",
    # caption = "Source: household survey + census"
  )

plot_grid(p1,p2,p3,p4,p5,p6,nrow = 3,ncol = 2)
```



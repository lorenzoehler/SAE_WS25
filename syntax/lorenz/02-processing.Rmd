---
title: "preprocessing data for model"
author: "Lorenz Alban Oehler"
date: "The Date"
output:
  html_document:
    theme: flatly      
    toc: true          
    toc_float: true    
    toc_depth: 4       
    highlight: tango   
    df_print: paged    
    css: styles.css 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(reactable)
library(data.table)
library(openxlsx)
```

# Introduction
The goal of this script is to transform the variables into form that is not only usable for the r lm, but also for emdi and saeTrafe. This means to convert factors into dummy coded variables. 

For now only these variables will be used: 
p26_edad, p25_sexo, ocu_1d_13, urbrur, p40_lee

To make this process also work for more than this one factor, I will first create a table in excel that maps the level to name, then will write a function in r that creates a new column var each dummy variable.

# mapping of dummys

## load in excel 
The excel file is set up in the way, that the sheet names are the names of the variable, that is being recoded with a value and a label column, every value gets its own row, if a new level contains multiple levels the respecitve values all get the same label. 

```{r}
### load in sample 
sample <- readRDS("../../data_raw/samples/sample_for_model_building.RDS")

### get sheet names
sheets <- getSheetNames("../../data_raw/mapping/dummy_coding.xlsx")

### look at matches 
sheets %in% colnames(sample)
```

## remap 

```{r}
### for debugging
# column <- sample[[sheets[i]]]
# mapping_sheet <- tmp_sheet
# name_variable <- sheets[i]

fun.mappingDummyCoding <- function(column, name_variable, mapping_sheet) {

  ### create rest column
  rest_cat <- paste0(name_variable, "_REST")
  
  ### all the possible levels after dummy coding
  levels_out <- c(unique(mapping_sheet$label), rest_cat)

  ### initialize empty matrix with all 0 
  out <- matrix(
    0L,
    nrow = length(column),
    ncol = length(levels_out),
    dimnames = list(NULL, levels_out)
  )

  # match observed values to mapping sheet ==> output is matrix with position of the category that matches input in mappping frame
  idx <- match(column, mapping_sheet$value)

  # rows that have a mapping
  valid <- !is.na(idx)
  # all(valid == TRUE) ### could be used to only create rest category, if some dont match 
  
  # for all valid observations we match values to the matrix
  # then the match in levels out gets determined
  col_idx <- match(mapping_sheet$label[idx[valid]], levels_out)

  # out at this point is still just zeros
  # the col_idx column then indicats which of the colums gets the one for the respective row 
  out[cbind(which(valid), col_idx)] <- 1L

  # fill rest category
  out[!valid, rest_cat] <- 1L

as.data.frame(out)
}



```


```{r}
### defining variables 
path_excel <- "../../data_raw/mapping/dummy_coding.xlsx"

### select variables which are of interst for now 
sheets_selection <- sheets[c(1,4,5,6)]
# paste0(sheets_selection,collapse = '","')  %>% cat()
sheets_selection <- c("ocu_1d_13","p25_sexo","p40_lee","urbrur")

### initialize empy data frame
size <- nrow(sample)
dummy_coding <- data.frame(matrix(nrow = size,ncol = 0))

for(i in seq_along(sheets_selection)){
 tmp_sheet <- read.xlsx(xlsxFile = path_excel,sheet = sheets_selection[i]) 
 tmp_mapping_sheet <- tmp_sheet %>% mutate(label = paste0(prefix, label)) %>% select(value, label)
 
 tmp_col_dummy_coding <- fun.mappingDummyCoding(column = sample[[sheets_selection[i]]],
                        name_variable = sheets_selection[i],
                        mapping_sheet = tmp_mapping_sheet)
 
 dummy_coding <- cbind(dummy_coding,tmp_col_dummy_coding)
}


### add other columns 
sample_transformed <- sample %>% select(ID_prov,aestudio,p26_edad) %>% cbind(.,dummy_coding)

saveRDS(sample_transformed,"../../data_raw/samples/sample_for_model_building_transformed.RDS")

# dummy_coding
```


## create 

For now the recoding of the dummy variables, always creats a rest category and a column for each level -- which does not always makes sense, thus some of the variables are deleted before being put into the equation, this is the one we will use for now. 

```{r}
# paste0(colnames(sample_transformed),collapse =  " + ") ### delete the rest categories in some cases, and for the true bin ones, decide for one
model <- lm(aestudio ~ p26_edad + ocu_military + ocu_manager + ocu_professional + ocu_technician + ocu_adminSupport + ocu_serviceSales + ocu_agriculture + ocu_construction + ocu_operators + ocu_unskilled + ocu_NaN + ocu_1d_13_REST + sex_female + read_knowing + urbrur_urban
            ,data = sample_transformed)

model %>% summary ()
```

# transform variables of census data

```{r}
dat <- readRDS("../../data_raw/large_files/dat_preprocessing-01.RDS")

### first colums have â€ o be transformed
size <- nrow(dat)
dummy_coding <- data.frame(matrix(nrow = size,ncol = 0))

for(i in seq_along(sheets_selection)){
 tmp_sheet <- read.xlsx(xlsxFile = path_excel,sheet = sheets_selection[i]) 
 tmp_mapping_sheet <- tmp_sheet %>% mutate(label = paste0(prefix, label)) %>% select(value, label)
 
 tmp_col_dummy_coding <- fun.mappingDummyCoding(column = dat[[sheets_selection[i]]],
                        name_variable = sheets_selection[i],
                        mapping_sheet = tmp_mapping_sheet)
 
 dummy_coding <- cbind(dummy_coding,tmp_col_dummy_coding)
}


### add numeric values and ID col
dat_transformed <- dat %>% select(aestudio,p26_edad,ID_prov) %>% cbind(.,dummy_coding)

## save transformed census
saveRDS(dat_transformed,"../../data_raw/2024_census/processed/dat_dummyCoding.RDS")
```

# calculate auxillary data for FH model 

```{r}
### calculate auxi
covariats_numeric <-c("p26_edad")

covariats_factors <- c(
  "ocu_military",
  "ocu_manager",
  "ocu_professional",
  "ocu_technician",
  "ocu_adminSupport",
  "ocu_serviceSales",
  "ocu_agriculture",
  "ocu_construction",
  "ocu_operators",
  "ocu_unskilled",
  "ocu_NaN",
  "ocu_1d_13_REST",
  "sex_female",
  "read_knowing",
  "urbrur_urban"
)


dat_census_aux <- dat_transformed %>%
  group_by(ID_prov) %>%
  summarise(
    across(all_of(covariats_numeric), ~ mean(.x, na.rm = TRUE), .names = "mean_{.col}"),
    across(all_of(covariats_factors), ~ mean(.x == 1, na.rm = TRUE), .names = "share_{.col}")
  ) %>%
  ungroup()

saveRDS(dat_census_aux,"../../data_raw/2024_census/processed/census_aux_data_aggregated.RDS")

```


```{r}
# 
# fh_model <- fh(
#   fixed = Mean_aestudio ~ mean_p26_edad + share_p25_sexo_t + share_p40_lee_t +
#            share_hh_urb_t  + share_ocu_adminSupport +
#            share_ocu_serviceSales + share_ocu_agriculture + share_ocu_construction +
#            share_ocu_operators + share_ocu_unskilled + share_ocu_incomplete,
#   vardir = "Var_aestudio",
#   combined_data = domain_cov_clean,
#   domains = "matchingID",
#   method = "reml",
#   MSE = T
# )
# 
# 
# #### deleting lee, because mabye perfectly correlates with ocupations
# fh_model <- fh(
#   fixed = Mean_aestudio ~ mean_p26_edad + share_p25_sexo_t  +
#           # share_hh_urb_t  +
#     share_ocu_adminSupport +
#            share_ocu_serviceSales + share_ocu_agriculture + share_ocu_construction +
#            share_ocu_operators + share_ocu_unskilled + share_ocu_incomplete,
#   vardir = "Var_aestudio",
#   combined_data = domain_cov_clean,
#   domains = "matchingID",
#   method = "reml",
#   MSE = T
# )
# 
# fh_model$MSE$FH %>% mean()
# 
# fh_model_null <- fh(
#   fixed = Mean_aestudio ~ 1,
#   vardir = "Var_aestudio",
#   combined_data = domain_cov_clean,
#   domains = "matchingID",
#   method = "reml",
#   MSE = T
# )
# 
# fh_model_null$MSE$FH %>% mean()
# 
# 
# 
# min(domain_cov$Var_aestudio)
# 
# domain_cov %>% str()
# 
# any(is.na(domain_cov$Mean_aestudio))
# any(is.na(domain_cov$matchingID))
# length(unique(domain_cov$matchingID)) == nrow(domain_cov)
# 
# str(domain_cov)
# 
# str(domain_cov$Mean_aestudio)
# any(is.na(domain_cov$Mean_aestudio))
# 
# sapply(domain_cov %>% select(starts_with("mean_"), starts_with("share_")), class)
# 
# domain_cov <- domain_cov %>%
#   mutate(across(starts_with("mean_"), as.numeric),
#          across(starts_with("share_"), as.numeric))
# 
# any(is.na(domain_cov$matchingID))
# length(unique(domain_cov$matchingID)) == nrow(domain_cov)
# 
# 
# domain_cov_clean <- domain_cov %>% select(matchingID,Mean_aestudio,Var_aestudio,mean_p26_edad,share_p25_sexo_t) %>% as.data.frame()
# 
# fh_model <- fh(
#   fixed = Mean_aestudio ~ mean_p26_edad + share_p25_sexo_t,
#   vardir = "Var_aestudio",
#   combined_data = domain_cov_clean,
#   domains = "matchingID",
#   method = "reml",
#   MSE = T
# )
# 
# fh_model

```
```


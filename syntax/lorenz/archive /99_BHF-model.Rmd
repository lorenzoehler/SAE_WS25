---
title: "BHF Model"
author: "Lorenz Oehler"
date: "2025-12-28"
output:
  html_document:
    theme: flatly      
    toc: true          
    toc_float: true    
    toc_depth: 4       
    highlight: tango   
    df_print: paged    
    css: styles.css 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Prep

```{r}
### loading packages
library(haven)
library(reactable)
library(sf)
library(data.table)
library(saeTrafo)
library(tidyverse) # load so that select() is used from this package
remove(list = ls())
```

# Introduction
Goal of this document is to just fit an initial, simple model to demonstrate, that we can run a BHF with our data and plot them on a map.

The model I will use for now ist:    
aestudio ~ p25_sexo + p26_edad

# Processing data 

## load data 

```{r}
sample <- readRDS("../../data_raw/samples/sample_for_model_building.RDS")
dat_census_pers <- fread("../../data_raw/large_files/Persona_CPV-2024.csv")

dat_census_pers$ID_prov <- paste0("BO",
  sprintf("%02d",dat_census_pers$idep),
  sprintf("%02d",dat_census_pers$iprov)
  )

sample$ID_prov <- paste0("BO",
  sprintf("%02d",sample$idep),
  sprintf("%02d",sample$iprov)
  )
```

## select variables

### census

```{r}
### select variables census
variables <- c("ID_prov", "p25_sexo","p26_edad")

### filter for some of the variables and only use people older than 18
dat_census_pers <- dat_census_pers %>% filter(p26_edad > 18) %>% select("ID_prov","p25_sexo","p26_edad")
```

### sample

```{r}
### select variables sample
variables <- c("ID_prov","aestudio", "p25_sexo","p26_edad")
sample <- sample %>% select(variables)
```

## check for NAs

```{r}
### check if no NAs exist census
sapply(dat_census_pers,function(x) sum(is.na(x)))

sapply(sample,function(x) sum(is.na(x)))
```
# Model fit 

```{r}
### look if there is a connection between tha predictors and the dependend variable
lm(formula = aestudio ~ p25_sexo + p26_edad, data = sample) %>% summary()
```
The model has a fairly good fit for two variables

# sample description 

## n per domina

```{r}
freq <- dat_census_pers %>% group_by(ID_prov) %>% count()
freq %>% reactable(.,filterable = T)

freq_sample <- sample %>% group_by(ID_prov) %>% count()
freq_sample %>% reactable(.,filterable = T)
```

# BHF model

```{r}
### create vector with sizo of domains
table_pop_size <- dat_census_pers %>% group_by(ID_prov) %>% count()
vec_pop_size <- table_pop_size$n
names(vec_pop_size) <- table_pop_size$ID_prov


BHF_unit <-  NER_Trafo(fixed = aestudio ~ p25_sexo + p26_edad
    ,MSE = T
    ,smp_domains = "ID_prov"
    ,smp_data = sample
    ,pop_data = dat_census_pers
    ,pop_area_size = vec_pop_size
    ,pop_domains = "ID_prov"
    ,transformation = "no"
    ,seed = 2022)


# BHF_unit_null <-  NER_Trafo(fixed = aestudio ~ 1
#     ,MSE = T
#     ,smp_domains = "ID_prov"
#     ,smp_data = sample
#     ,pop_data = dat_census_pers
#     ,pop_area_size = vec_pop_size
#     ,pop_domains = "ID_prov"
#     ,transformation = "no"
#     ,seed = 2022)

```

# map of results

```{r}
dat_domains <- BHF_unit$ind
colnames(dat_domains) <- c("ADM2_PCODE","Mean_aestudio")

map <- read_sf("../../data_raw/shape/bol_adm_mdrt_2013/bol_admbnd_adm2_mdrt_2013_v01.shp")

map_merged <- map %>%
  left_join(dat_domains, by = "ADM2_PCODE")


ggplot(map_merged) +
  geom_sf(aes(fill = Mean_aestudio), color = "grey20", size = 0.1) +
  theme_classic()
```



---
title: "Variable selection"
author: "Lorenz Alban Oehler"
date: "The Date"
output:
  html_document:
    theme: flatly      
    toc: true          
    toc_float: true    
    toc_depth: 4       
    highlight: tango   
    df_print: paged    
    css: styles.css 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# introduction

In this document I want to 
- take a look at the census data set
- figure out a way of opening and manipulating the whole dataset
- figure out a systematic way of renaming the variables 

# Preprocessing

## loading the data

```{r}

library(data.table)
library(tidyverse)

Vivienda_CPV_2024 <- fread("../../data_raw/large_files/Vivienda_CPV-2024.csv")
head1000_houshold <- fread("../../data_raw/large_files/Vivienda_CPV-2024.csv", nrows = 10000)
head1000_houshold %>% lapply(X = .,FUN = summary)

```

## census

```{r}
sample <- readRDS("../../data_raw/samples/sample_for_model_building.RDS")
dat_census_pers <- fread(
  "../../data_raw/large_files/Persona_CPV-2024.csv",
  # select = c("mun_res_cod","idep","iprov","imun", "p25_sexo","p26_edad")
)

```

### replace unknown location with NA


no value in either the iprov, idep or imun should be 99

```{r}
dat_census_pers %>% filter(imun == 99)


dat_census_pers %>% group_by(mun_res_cod) %>% count()
```
look into some examples
51399,60199,0

```{r}
head(dat_census_pers[dat_census_pers$mun_res_cod == 0, c("idep","iprov","imun","mun_res_cod", "mun_lab_cod", "mun_nac_cod","mun_res5_cod")],10)
```
- "mun_res_cod", - municipio de residencia habitual (municipality in which person usually lives)
"mun_lab_cod", - municipality in which person works 
"mun_nac_cod", - municipality in which person was born 
"mun_res5_cod" - municipality in which person lived 5 years ago

=> we should for simplicity still create a matchingID cause no missing values there


### matchingID

```{r}
dat_census_pers$matchingID <- paste0(
  sprintf("%02.0f", dat_census_pers$idep),
  sprintf("%02.0f", dat_census_pers$iprov),
  sprintf("%02.0f", dat_census_pers$imun)) %>% as.numeric()
```


### selection of variables 

```{r}
dat_census_pers %>% colnames()

### just for now, to make loading etc more simple 
dat_census_pers_selection <- dat_census_pers[,c(119,1:18,53,82:95)]
```

### selection of age
- only people 18 and older 

```{r}
dat_census_pers_selection <- dat_census_pers_selection %>% filter(p26_edad >= 18)
```


### only people with value in aestudio

```{r}
is.na(dat_census_pers_selection$aestudio) %>% sum()
dat_census_pers_selection <- dat_census_pers_selection[!is.na(dat_census_pers_selection$aestudio),]
```



```{r}
saveRDS(dat_census_pers_selection,"../../data_raw/large_files/dat_census_pers_selection.RDS")
```

## shape file

```{r}
map <- read_sf("../../data_raw/shape/bol_adm_mdrt_2013/bol_admbnd_adm3_mdrt_2013_v01.shp")

matchingID <- data.frame("matchingID" = str_remove(map$ADM3_PCODE,pattern = "BO") %>% as.numeric())

map <- cbind(matchingID,map)
map <- map %>% st_as_sf()

saveRDS(map,"../../data_raw/shape/map.RDS")
```



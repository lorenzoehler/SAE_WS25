---
title: "Template Title"
author: "Lorenz Alban Oehler"
date: "The Date"
output:
  html_document:
    theme: flatly      
    toc: true          
    toc_float: true    
    toc_depth: 4       
    highlight: tango   
    df_print: paged    
    css: styles.css 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(cowplot)
library(sf)
```

# loading data 

```{r}
dat_MSE <- readRDS("../../data_raw/simulation/processed/df_MSE_long.RDS")
dat_estimate <- readRDS("../../data_raw/simulation/processed/df_estimates_long.RDS")

map <- read_sf("../../data_raw/shape/bol_adm_mdrt_2013/bol_admbnd_adm2_mdrt_2013_v01.shp")
map <- map %>% rename(ID_prov = ADM2_PCODE )

```


```{r}
colo <- list(
  AP = c("#FBBF24", "#22D3EE", "#FB7185", "#E5E7EB"),
  BP = c("#E5E7EB", "#38BDF8", "#A3E635"),
  CP = c("#FACC15", "#22D3EE", "#4ADE80", "#FB923C", "#F472B6")
)
```

# MSE

## data processing

```{r}
df_MSE_agg_samples_long <- dat_MSE %>% 
  group_by(ID_prov,method) %>% 
  summarise(mean_samples = mean(MSE))

df_MSE_agg_samples_wide <- pivot_wider(
  df_MSE_agg_samples_long,
  id_cols   = ID_prov,
  names_from = method,
  values_from = mean_samples
)

colnames(df_MSE_agg_samples_wide) <- c("ID_prov","MSE_BHF_mean_samples","MSE_Dir_mean_samples","MSE_FH_mean_samples")

map <- map %>% left_join(df_MSE_agg_samples_wide,by = "ID_prov")
```


```{r}
### define styel
map_style_beamer <- theme(
    plot.title = element_text(hjust = 0.5),
    legend.position = "right",
    legend.title.position = "top",
    # legend.key.height = unit(3, "mm"),
    # legend.key.width  = unit(4, "mm"),
    legend.title = element_text(size = 9),
    # legend.text  = element_text(size = 8),
    # legend.margin = margin(0, 0, 0, 0),
    # legend.box.margin = margin(0, 0, 0, 0),
    axis.title = element_blank(),
    axis.text  = element_blank(),
    axis.ticks = element_blank(),
    axis.line  = element_blank(),
    panel.grid = element_blank(),
    panel.background = element_rect(fill = NA, colour = NA),
    plot.background  = element_rect(fill = NA, colour = NA)
  )

scale_fill_mse <- function(limits, name = "Mean MSE",colours = c("#134E4A", "#2A9D8F", "#FACC15")) {
  scale_fill_gradientn(
    colours = colours,
    na.value = "#334155",
    limits = limits,
    name = name
  )
}

```

## Mean MSE
which is the MSE aggregated over all samples 

### direct vs FH vs BHF

```{r}
global_limits <- df_MSE_agg_samples_long %>% pull(mean_samples) %>% range()

p_map <- ggplot(map) +
  geom_sf(aes(fill = MSE_BHF_mean_samples)) +
  scale_fill_mse(global_limits) +
  map_style_beamer

legend_map <- get_legend(p_map)

p1 <- ggplot(map) +
  geom_sf(aes(fill = MSE_BHF_mean_samples)) +
  scale_fill_mse(global_limits) +
  map_style_beamer +
  theme(legend.position = "none") +
  labs(title = "BHF")

p2 <- ggplot(map) +
  geom_sf(aes(fill = MSE_FH_mean_samples)) +
  scale_fill_mse(global_limits) +
  map_style_beamer +
  theme(legend.position = "none") +
  labs(title = "FH")

p3 <- ggplot(map) +
  geom_sf(aes(fill = MSE_Dir_mean_samples)) +
  scale_fill_mse(global_limits) +
  map_style_beamer +
  theme(legend.position = "none") +
  labs(title = "Direct")

# plot_grid(cowplot::plot_grid(p1,p2,p3,nrow = 1),legend_map,nrow = 2,rel_widths = c(3,.2)) # two rows
plot_grid(p1,p2,p3,legend_map,nrow = 1,rel_widths = c(1,1,1,.5))
```
### FH vs BHF

```{r}
global_limits <- df_MSE_agg_samples_long %>% filter(method!= "Dir") %>% pull(mean_samples) %>% range()

p_map <- ggplot(map) +
  geom_sf(aes(fill = MSE_BHF_mean_samples)) +
  scale_fill_mse(global_limits) +
  map_style_beamer

legend_map <- get_legend(p_map)


p1 <- ggplot(map) +
  geom_sf(aes(fill = MSE_BHF_mean_samples)) +
  scale_fill_mse(global_limits) +
  map_style_beamer +
  theme(legend.position = "none") +
  labs(title = "BHF")


p2 <- ggplot(map) +
  geom_sf(aes(fill = MSE_FH_mean_samples)) +
  scale_fill_mse(global_limits) +
  map_style_beamer +
  theme(legend.position = "none") +
  labs(title = "FH")

MSE_mean_FH_BHF_samples_aggre <- plot_grid(p1,p2,legend_map,nrow = 1,rel_widths = c(1,1,.5))

MSE_mean_FH_BHF_samples_aggre 
ggsave("../../output/MSE_mean_FH_BHF_samples_aggre-01.svg", 
       plot = MSE_mean_FH_BHF_samples_aggre,
       width = 6,      # width in inches
       height = 4,    # height in inches; make it long enough for 5 plots
       units = "in",   # units for width/height
       device = "svg")

ggsave("../../output/MSE_mean_FH_BHF_samples_aggre-01.png", 
       plot = MSE_mean_FH_BHF_samples_aggre,
       width = 6,      # width in inches
       height = 4,    # height in inches; make it long enough for 5 plots
       units = "in",   # units for width/height
       dpi = 300)

```


## MSE sample 1

```{r}
dat_MSE_s1 <- dat_MSE %>% 
  filter(sample == "001") %>% 
  mutate(MSE_s1 = MSE)

df_MSE_s1_wide <- pivot_wider(
  dat_MSE_s1,
  id_cols   = ID_prov,
  names_from = method,
  values_from = MSE_s1
)

colnames(df_MSE_s1_wide) <- c("ID_prov","MSE_Dir_s1","MSE_FH_s1","MSE_BFH_s1")

map <- map %>% left_join(df_MSE_s1_wide,by = "ID_prov")
```


### FH vs BHF

```{r}
global_limits <- dat_MSE_s1 %>% filter(method != "Dir") %>% pull(MSE_s1) %>% range()

p_map <- ggplot(map) +
  geom_sf(aes(fill = MSE_BHF_mean_samples)) +
  scale_fill_mse(global_limits) +
  map_style_beamer

legend_map <- get_legend(p_map)

p1 <- ggplot(map) +
  geom_sf(aes(fill = MSE_BFH_s1)) +
  scale_fill_mse(global_limits) +
  map_style_beamer +
  theme(legend.position = "none") +
  labs(title = "BHF")


p2 <- ggplot(map) +
  geom_sf(aes(fill = MSE_FH_s1)) +
  scale_fill_mse(global_limits) +
  map_style_beamer +
  theme(legend.position = "none") +
  labs(title = "FH")

MSE_mean_FH_BHF_samples_aggre <- plot_grid(p1,p2,legend_map,nrow = 1,rel_widths = c(1,1,.5))

```

# plotting estimates

## processing

```{r}
df_estimate_agg_samples_long <- dat_estimate %>% 
  group_by(ID_prov,method) %>% 
  summarise(mean_estimate = mean(estimate),
            var_estimate = var(estimate)
            )

df_estimate_agg_samples_wide <- pivot_wider(
  df_estimate_agg_samples_long,
  id_cols   = ID_prov,
  names_from = method,
  values_from = c(mean_estimate,var_estimate)
)

colnames(df_estimate_agg_samples_wide) <- c("ID_prov","estimate_BHF_mean_samples","estimate_Dir_mean_samples","estimate_FH_mean_samples","estimate_BHF_var_samples","estimate_Dir_var_samples","estimate_FH_var_samples")

map <- map %>% left_join(df_estimate_agg_samples_wide,by = "ID_prov")
```

### BHF vs FH vs Direct

```{r}
global_limits <- df_estimate_agg_samples_long %>% pull(mean_estimate) %>% range()

p_map <- ggplot(map) +
  geom_sf(aes(fill = estimate_BHF_mean_samples)) +
  scale_fill_mse(global_limits) +
  map_style_beamer

legend_map <- get_legend(p_map)


p1 <- ggplot(map) +
  geom_sf(aes(fill = estimate_Dir_mean_samples)) +
  scale_fill_mse(global_limits) +
  map_style_beamer +
  theme(legend.position = "none") +
  labs(title = "Direct")


p2 <- ggplot(map) +
  geom_sf(aes(fill = estimate_FH_mean_samples)) +
  scale_fill_mse(global_limits) +
  map_style_beamer +
  theme(legend.position = "none") +
  labs(title = "FH")

p3 <- ggplot(map) +
  geom_sf(aes(fill = estimate_BHF_mean_samples)) +
  scale_fill_mse(global_limits) +
  map_style_beamer +
  theme(legend.position = "none") +
  labs(title = "BHF")

estimate_mean_Dir_FH_BHF_samples_aggre <- plot_grid(p1,p2,p3,legend_map,nrow = 1,rel_widths = c(1,1,1,.5))
estimate_mean_Dir_FH_BHF_samples_aggre
ggsave("../../output/estimate_mean_Dir_FH_BHF_samples_aggre-01.svg", 
       plot = estimate_mean_Dir_FH_BHF_samples_aggre,
       width = 6,      # width in inches
       height = 4,    # height in inches; make it long enough for 5 plots
       units = "in",   # units for width/height
       device = "svg")

ggsave("../../output/estimate_mean_Dir_FH_BHF_samples_aggre.png", 
       plot = estimate_mean_Dir_FH_BHF_samples_aggre,
       width = 6,      # width in inches
       height = 4,    # height in inches; make it long enough for 5 plots
       units = "in",   # units for width/height
       dpi = 300)

```

### variance

```{r}
global_limits <- df_estimate_agg_samples_long %>% pull(var_estimate) %>% range()

p_map <- ggplot(map) +
  geom_sf(aes(fill = estimate_BHF_var_samples)) +
  scale_fill_mse(global_limits) +
  map_style_beamer

legend_map <- get_legend(p_map)


p1 <- ggplot(map) +
  geom_sf(aes(fill = estimate_Dir_var_samples)) +
  scale_fill_mse(global_limits) +
  map_style_beamer +
  theme(legend.position = "none") +
  labs(title = "Direct")


p2 <- ggplot(map) +
  geom_sf(aes(fill = estimate_FH_var_samples)) +
  scale_fill_mse(global_limits) +
  map_style_beamer +
  theme(legend.position = "none") +
  labs(title = "FH")

p3 <- ggplot(map) +
  geom_sf(aes(fill = estimate_BHF_var_samples)) +
  scale_fill_mse(global_limits) +
  map_style_beamer +
  theme(legend.position = "none") +
  labs(title = "BHF")

estimate_var_Dir_FH_BHF_samples_aggre <- plot_grid(p1,p2,p3,legend_map,nrow = 1,rel_widths = c(1,1,1,.5))
estimate_var_Dir_FH_BHF_samples_aggre

ggsave("../../output/estimate_var_Dir_FH_BHF_samples_aggre-01.svg", 
       plot = estimate_var_Dir_FH_BHF_samples_aggre,
       width = 6,      # width in inches
       height = 4,    # height in inches; make it long enough for 5 plots
       units = "in",   # units for width/height
       device = "svg")

ggsave("../../output/estimate_var_Dir_FH_BHF_samples_aggre.png", 
       plot = estimate_var_Dir_FH_BHF_samples_aggre,
       width = 6,      # width in inches
       height = 4,    # height in inches; make it long enough for 5 plots
       units = "in",   # units for width/height
       dpi = 300)
```
# Diff to real value

## processing

```{r}
df_var_diff_true_agg_samples_long <- dat_estimate %>% 
  group_by(ID_prov,method) %>% 
  summarise(mean_diff_true = mean(diff_true),
            var_diff_true = var(diff_true))

# ggplot(dat_estimate,aes(x = method, y = diff_true, fill = diff_true))+
#   geom_boxplot()

df_var_diff_true_agg_samples_wide <- pivot_wider(
  df_var_diff_true_agg_samples_long,
  id_cols   = ID_prov,
  names_from = method,
  values_from = c(mean_diff_true,var_diff_true)
)

colnames(df_var_diff_true_agg_samples_wide) <- c("ID_prov","diff_true_BHF_mean_samples","diff_true_Dir_mean_samples","diff_true_FH_mean_samples","diff_true_BHF_var_samples","diff_true_Dir_var_samples","diff_true_FH_var_samples")

map <- map %>% left_join(df_var_diff_true_agg_samples_wide,by = "ID_prov")
# colnames(map)
```

### BHF vs FH vs Direct

```{r}
global_limits <- df_var_diff_true_agg_samples_long %>% pull(mean_diff_true) %>% range()

p_map <- ggplot(map) +
  geom_sf(aes(fill = diff_true_Dir_mean_samples)) +
  scale_fill_mse(global_limits,
                 name = "mean difference to true value",
                 colours = c("#22D3EE", "#0F172A", "#FB7185")) +
  map_style_beamer

legend_map <- get_legend(p_map)


p1 <- ggplot(map) +
  geom_sf(aes(fill = diff_true_Dir_mean_samples)) +
  scale_fill_mse(global_limits,
                 colours = c("#22D3EE", "#0F172A", "#FB7185")) +
  map_style_beamer +
  theme(legend.position = "none") +
  labs(title = "Direct")


p2 <- ggplot(map) +
  geom_sf(aes(fill = diff_true_FH_mean_samples)) +
  scale_fill_mse(global_limits,
                 colours = c("#22D3EE", "#0F172A", "#FB7185")) +
  map_style_beamer +
  theme(legend.position = "none") +
  labs(title = "FH")

p3 <- ggplot(map) +
  geom_sf(aes(fill = diff_true_BHF_mean_samples)) +
  scale_fill_mse(global_limits,
                 colours = c("#22D3EE", "#0F172A", "#FB7185")) +
  map_style_beamer +
  theme(legend.position = "none") +
  labs(title = "BHF")

diff_true_Dir_FH_BHF_samples_aggre <- plot_grid(p1,p2,p3,legend_map,nrow = 1,rel_widths = c(1,1,1,.5))
diff_true_Dir_FH_BHF_samples_aggre

ggsave("../../output/diff_true_Dir_FH_BHF_samples_aggre-01.svg", 
       plot = diff_true_Dir_FH_BHF_samples_aggre,
       width = 6,      # width in inches
       height = 4,    # height in inches; make it long enough for 5 plots
       units = "in",   # units for width/height
       device = "svg")

ggsave("../../output/diff_true_Dir_FH_BHF_samples_aggre-01.png", 
       plot = diff_true_Dir_FH_BHF_samples_aggre,
       width = 6,      # width in inches
       height = 4,    # height in inches; make it long enough for 5 plots
       units = "in",   # units for width/height
       dpi = 300)

```

### BHF vs FH vs Direct Sample 1

```{r}
df_diff_true_s1_long <- dat_estimate %>% 
  filter(sample == "001") 


df_var_diff_true_agg_samples_wide <- pivot_wider(
  df_diff_true_s1_long,
  id_cols   = ID_prov,
  names_from = method,
  values_from = diff_true)

colnames(df_var_diff_true_agg_samples_wide) <- c("ID_prov","diff_true_Dir_s1","diff_true_FH_s1","diff_true_BHF_s1")

map <- map %>% left_join(df_var_diff_true_agg_samples_wide,by = "ID_prov")
# colnames(map)
```


```{r}
global_limits <- df_diff_true_s1_long %>% pull(diff_true) %>% range()

p_map <- ggplot(map) +
  geom_sf(aes(fill = diff_true_Dir_s1)) +
  scale_fill_mse(global_limits,
                 name = "sample 1 difference to true value",
                 colours = c("#22D3EE", "#0F172A", "#FB7185")) +
  map_style_beamer

legend_map <- get_legend(p_map)


p1 <- ggplot(map) +
  geom_sf(aes(fill = diff_true_Dir_s1)) +
  scale_fill_mse(global_limits,
                 colours = c("#22D3EE", "#0F172A", "#FB7185")) +
  map_style_beamer +
  theme(legend.position = "none") +
  labs(title = "Direct")


p2 <- ggplot(map) +
  geom_sf(aes(fill = diff_true_FH_s1)) +
  scale_fill_mse(global_limits,
                 colours = c("#22D3EE", "#0F172A", "#FB7185")) +
  map_style_beamer +
  theme(legend.position = "none") +
  labs(title = "FH")

p3 <- ggplot(map) +
  geom_sf(aes(fill = diff_true_FH_s1)) +
  scale_fill_mse(global_limits,
                 colours = c("#22D3EE", "#0F172A", "#FB7185")) +
  map_style_beamer +
  theme(legend.position = "none") +
  labs(title = "BHF")

diff_true_Dir_FH_BHF_s1 <- plot_grid(p1,p2,p3,legend_map,nrow = 1,rel_widths = c(1,1,1,.8))
diff_true_Dir_FH_BHF_s1

ggsave("../../output/diff_true_Dir_FH_BHF_s1-01.svg", 
       plot = diff_true_Dir_FH_BHF_s1,
       width = 6,      # width in inches
       height = 4,    # height in inches; make it long enough for 5 plots
       units = "in",   # units for width/height
       device = "svg")

ggsave("../../output/diff_true_Dir_FH_BHF_s1-01.png", 
       plot = diff_true_Dir_FH_BHF_s1,
       width = 6,      # width in inches
       height = 4,    # height in inches; make it long enough for 5 plots
       units = "in",   # units for width/height
       dpi = 300)

```

### absolute difference
```{r}
df_abs_diff_true_agg_samples_long <- dat_estimate %>% 
  group_by(ID_prov,method) %>% 
  summarise(abs_mean_diff_true = mean(abs(diff_true)),
            abs_var_diff_true = var(abs(diff_true)))

# ggplot(dat_estimate,aes(x = method, y = diff_true, fill = diff_true))+
#   geom_boxplot()

df_abs_diff_true_agg_samples_wide <- pivot_wider(
  df_abs_diff_true_agg_samples_long,
  id_cols   = ID_prov,
  names_from = method,
  values_from = c(abs_mean_diff_true,abs_var_diff_true)
)

colnames(df_abs_diff_true_agg_samples_wide) <- c("ID_prov","abs_diff_true_BHF_mean_samples","abs_diff_true_Dir_mean_samples","abs_diff_true_FH_mean_samples","abs_diff_true_BHF_var_samples","abs_diff_true_Dir_var_samples","abs_diff_true_FH_var_samples")

map <- map %>% left_join(df_abs_diff_true_agg_samples_wide,by = "ID_prov")
# colnames(map)
```

### BHF vs FH vs Direct

```{r}
global_limits <- df_abs_diff_true_agg_samples_long %>% pull(abs_mean_diff_true) %>% range()

p_map <- ggplot(map) +
  geom_sf(aes(fill = abs_diff_true_BHF_mean_samples)) +
  scale_fill_mse(global_limits,
                 name = "abs mean difference to true value",
                 colours = c("#22D3EE", "#0F172A", "#FB7185")) +
  map_style_beamer

legend_map <- get_legend(p_map)


p1 <- ggplot(map) +
  geom_sf(aes(fill = abs_diff_true_Dir_mean_samples)) +
  scale_fill_mse(global_limits,
                 colours = c("#22D3EE", "#0F172A", "#FB7185")) +
  map_style_beamer +
  theme(legend.position = "none") +
  labs(title = "Direct")


p2 <- ggplot(map) +
  geom_sf(aes(fill = abs_diff_true_FH_mean_samples)) +
  scale_fill_mse(global_limits,
                 colours = c("#22D3EE", "#0F172A", "#FB7185")) +
  map_style_beamer +
  theme(legend.position = "none") +
  labs(title = "FH")

p3 <- ggplot(map) +
  geom_sf(aes(fill = abs_diff_true_BHF_mean_samples)) +
  scale_fill_mse(global_limits,
                 colours = c("#22D3EE", "#0F172A", "#FB7185")) +
  map_style_beamer +
  theme(legend.position = "none") +
  labs(title = "BHF")

abs_diff_true_Dir_FH_BHF_samples_aggre <- plot_grid(p1,p2,p3,legend_map,nrow = 1,rel_widths = c(1,1,1,.8))
abs_diff_true_Dir_FH_BHF_samples_aggre

ggsave("../../output/abs_diff_true_Dir_FH_BHF_samples_aggre-01.svg", 
       plot = abs_diff_true_Dir_FH_BHF_samples_aggre,
       width = 6,      # width in inches
       height = 4,    # height in inches; make it long enough for 5 plots
       units = "in",   # units for width/height
       device = "svg")

ggsave("../../output/abs_diff_true_Dir_FH_BHF_samples_aggre-01.png", 
       plot = abs_diff_true_Dir_FH_BHF_samples_aggre,
       width = 6,      # width in inches
       height = 4,    # height in inches; make it long enough for 5 plots
       units = "in",   # units for width/height
       dpi = 300)
```
# other plots 

## difference true value

```{r}
tmp_dat <- dat_MSE %>% group_by(sample,method) %>% reframe(mean_MSE = mean(MSE))

distance_true_value <- tmp_dat %>% filter(method != "Dir") %>% 
ggplot(., aes(x = method, y = mean_MSE, fill = method)) +
  geom_violin(alpha = 0.5) +
  geom_line(aes(group = sample), alpha = .2)+
  geom_point(alpha = .1)+
  geom_boxplot(width = 0.1, fill="white") +  # Boxplot in der Mitte
  scale_fill_manual(values = c("red","#7ca982")) +
  theme_minimal() +
  labs(title = "MSE Distribution by Estimator",
       y = "MSE")



ggsave("../../output/distance_true_value-01.svg", 
       plot = distance_true_value,
       width = 6,      # width in inches
       height = 4,    # height in inches; make it long enough for 5 plots
       units = "in",   # units for width/height
       device = "svg")

ggsave("../../output/distance_true_value-01.png", 
       plot = distance_true_value,
       width = 6,      # width in inches
       height = 4,    # height in inches; make it long enough for 5 plots
       units = "in",   # units for width/height
       dpi = 300)

```
## difference to true value 


```{r}
df_estimate_agg_samples_long <- dat_estimate


df_estimate_long <- pivot_wider(
  dat_estimate,
  id_cols   = c(ID_prov,sample),
  names_from = c(method),
  values_from = diff_true
)

colnames(df_estimate_agg_samples_wide) <- c("ID_prov","estimate_BHF_mean_samples","estimate_Dir_mean_samples","estimate_FH_mean_samples","estimate_BHF_var_samples","estimate_Dir_var_samples","estimate_FH_var_samples")

map <- map %>% left_join(df_estimate_agg_samples_wide,by = "ID_prov")
```

```{r}

distance_true_value <- ggplot(dat_estimate,aes(x = method,y = diff_true, fill = method)) +
  geom_jitter(alpha = .01) +
  geom_violin(alpha = .7) +
  scale_fill_manual(values = c("#7ca982","#334155","red")) +
  geom_boxplot(width = 0.1, fill="white") +
  labs(title = "Distance from the mean estimate for the province to the true mean",
       x = "method",
       y = "difference to true value")+
  theme_minimal()


ggsave("../../output/distance_true_value-02.svg", 
       plot = distance_true_value,
       width = 6,      # width in inches
       height = 4,    # height in inches; make it long enough for 5 plots
       units = "in",   # units for width/height
       device = "svg")

ggsave("../../output/distance_true_value-02.png", 
       plot = distance_true_value,
       width = 6,      # width in inches
       height = 4,    # height in inches; make it long enough for 5 plots
       units = "in",   # units for width/height
       dpi = 300)


```




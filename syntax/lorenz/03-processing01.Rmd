---
title: "preprocessing data for model"
author: "Lorenz Alban Oehler"
date: "The Date"
output:
  html_document:
    theme: flatly      
    toc: true          
    toc_float: true    
    toc_depth: 4       
    highlight: tango   
    df_print: paged    
    css: styles.css 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(reactable)
library(data.table)
library(openxlsx)
```

# Introduction
The goal of this script is to transform the variables into form that is not only usable for the r lm, but also for emdi and saeTrafe. This means to convert factors into dummy coded variables. 

For now only these variables will be used: 
p26_edad, p25_sexo, ocu_1d_13, urbrur, p40_lee

To make this process also work for more than this one factor, I will first create a table in excel that maps the level to name, then will write a function in r that creates a new column var each dummy variable.

# mapping of dummys

## load in excel 
The excel file is set up in the way, that the sheet names are the names of the variable, that is being recoded with a value and a label column, every value gets its own row, if a new level contains multiple levels the respecitve values all get the same label. 

```{r}
### load in sample 
sample <- readRDS("../../data_raw/samples/sample_for_model_building.RDS")

### get sheet names
sheets <- getSheetNames("../../data_raw/mapping/dummy_coding.xlsx")

### look at matches 
sheets %in% colnames(sample)
```

## remap 

```{r}
### defining variables 
path_excel <- "../../data_raw/mapping/dummy_coding.xlsx"

### for debugging
# column <- sample[[sheets[i]]]
# mapping_sheet <- tmp_sheet
# name_variable <- sheets[i]

### this function maps 
fun.mappingDummyCoding <- function(column, name_variable, mapping_sheet) {
  
  ### create list with all columnames and a rest-category
  tmp_rest_cat <- paste0(name_variable, "_REST")
  list_colums <- c(unique(mapping_sheet$label), tmp_rest_cat)
  
  ### empty data frame
  tmp_data <- data.frame(matrix(ncol = length(list_colums), nrow = 0))
  colnames(tmp_data) <- list_colums
  
  for (i in seq_along(column)) {
    tmp_vec <- rep(0, length(list_colums))
    names(tmp_vec) <- list_colums
    
    if (column[i] %in% mapping_sheet$value) {
      ### this part which(column[i] == mapping_sheet$value) gives the value which category is the true one
      tmp_vec[which(mapping_sheet$label[which(column[i] == mapping_sheet$value)] == names(tmp_vec))] <- 1
      
      ### write vector with 0s and the single 1 to the new data frame
      tmp_data[i, ] <- tmp_vec
      
    } else {
      tmp_vec[which(tmp_rest_cat == colnames(tmp_data))] <- 1
      tmp_data[i, ] <- tmp_vec
    }
  }
  return(tmp_data)
  
}

fun.mappingDummyCoding <- function(column, name_variable, mapping_sheet) {

  ### create rest column
  rest_cat <- paste0(name_variable, "_REST")
  
  ### all the possible levels after dummy coding
  levels_out <- c(unique(mapping_sheet$label), rest_cat)

  ### initialize empty matrix with all 0 
  out <- matrix(
    0L,
    nrow = length(column),
    ncol = length(levels_out),
    dimnames = list(NULL, levels_out)
  )

  # match observed values to mapping sheet
  idx <- match(column, mapping_sheet$value)

  # rows that have a mapping
  valid <- !is.na(idx)

  # map labels to column indices
  col_idx <- match(mapping_sheet$label[idx[valid]], levels_out)

  # fill mapped categories
  out[cbind(which(valid), col_idx)] <- 1L

  # fill rest category
  out[!valid, rest_cat] <- 1L

test01 <-   as.data.frame(out)
}



```


```{r}
dummy_coding <- data.frame(matrix(nrow = nrow(sample),ncol = 0))

### slect sheets which 
sheets_selection <- sheets[1]


for(i in seq_along(sheets_selection)){
 tmp_sheet <- read.xlsx(xlsxFile = path_excel,sheet = sheets_selection[i]) 
 tmp_mapping_sheet <- tmp_sheet %>% mutate(label = paste0(prefix, label)) %>% select(value, label)
 
 tmp_col_dummy_coding <- fun.mappingDummyCoding(column = sample[[sheets_selection[i]]],
                        name_variable = sheets_selection[i],
                        mapping_sheet = tmp_mapping_sheet)
 
 dummy_coding <- cbind(dummy_coding,tmp_col_dummy_coding)
}

# dummy_coding
```

```{r}
### add the numeric variables
sample_transformed <- sample %>% select(aestudio,p26_edad) %>% cbind(.,dummy_coding)
```



## create 

```{r}

# paste0(colnames(sample_transformed),collapse =  " + ")
model <- lm(aestudio ~ p26_edad + ocu_military + ocu_manager + ocu_professional + ocu_technician + ocu_adminSupport + ocu_serviceSales + ocu_agriculture + ocu_construction + ocu_operators + ocu_unskilled + ocu_NaN + ocu_1d_13_REST + combus_transitional_energy + combus_high_SES + combus_low_SES + combus_other + v10_combus_REST + piso_low_SES + piso_high_SES + piso_middle_SES + piso_super_high_SES + v06_piso_REST,data = sample_transformed)

model %>% summary ()
```

```{r}
# plot(domain_cov_clean$Mean_aestudio, fh_model$est$FH)
# abline(0,1,col="red")
# 
# # fh_model <- fh(
# #   fixed = Mean_aestudio ~ mean_p26_edad + share_p25_sexo_t + share_p40_lee_t +
# #            share_hh_urb_t  + share_ocu_adminSupport +
# #            share_ocu_serviceSales + share_ocu_agriculture + share_ocu_construction +
# #            share_ocu_operators + share_ocu_unskilled + share_ocu_incomplete,
# #   vardir = "Var_aestudio",       
# #   combined_data = domain_cov_clean,    
# #   domains = "matchingID",        
# #   method = "reml",               
# #   MSE = T                     
# # )
# 
# 
# #### deleting lee, because mabye perfectly correlates with ocupations
# fh_model <- fh(
#   fixed = Mean_aestudio ~ mean_p26_edad + share_p25_sexo_t  +
#           # share_hh_urb_t  +
#     share_ocu_adminSupport +
#            share_ocu_serviceSales + share_ocu_agriculture + share_ocu_construction +
#            share_ocu_operators + share_ocu_unskilled + share_ocu_incomplete,
#   vardir = "Var_aestudio",
#   combined_data = domain_cov_clean,
#   domains = "matchingID",
#   method = "reml",
#   MSE = T
# )
# 
# fh_model$MSE$FH %>% mean()
# 
# fh_model_null <- fh(
#   fixed = Mean_aestudio ~ 1,
#   vardir = "Var_aestudio",       
#   combined_data = domain_cov_clean,    
#   domains = "matchingID",        
#   method = "reml",               
#   MSE = T                    
# )
# 
# fh_model_null$MSE$FH %>% mean()
# 
# 
# 
# min(domain_cov$Var_aestudio)
# 
# domain_cov %>% str()
# 
# any(is.na(domain_cov$Mean_aestudio))
# any(is.na(domain_cov$matchingID))
# length(unique(domain_cov$matchingID)) == nrow(domain_cov)
# 
# str(domain_cov)
# 
# str(domain_cov$Mean_aestudio)
# any(is.na(domain_cov$Mean_aestudio))
# 
# sapply(domain_cov %>% select(starts_with("mean_"), starts_with("share_")), class)
# 
# domain_cov <- domain_cov %>%
#   mutate(across(starts_with("mean_"), as.numeric),
#          across(starts_with("share_"), as.numeric))
# 
# any(is.na(domain_cov$matchingID))
# length(unique(domain_cov$matchingID)) == nrow(domain_cov)
# 
# 
# domain_cov_clean <- domain_cov %>% select(matchingID,Mean_aestudio,Var_aestudio,mean_p26_edad,share_p25_sexo_t) %>% as.data.frame()
# 
# fh_model <- fh(
#   fixed = Mean_aestudio ~ mean_p26_edad + share_p25_sexo_t,
#   vardir = "Var_aestudio",
#   combined_data = domain_cov_clean,
#   domains = "matchingID",
#   method = "reml",
#   MSE = T
# )
# 
# fh_model

```
```


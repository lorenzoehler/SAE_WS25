---
#########################################################################
# AREA-LEVEL SAE (Fay–Herriot) - FULL PIPELINE
# 1) Sample -> direct estimates (Mean) + sampling variance (Var_Mean)
#    das heißt aus dem Sample Datensatz habe ich pro Municipio den direkten Schätzer
#    und seine Varianz gebaut
# 2) Census -> auxiliary X (mean_years_edu) per municipio
#    Aus dem Census habe ich die Area-Level-Hilfsvariable (Kovariate) gebaut (mean_years_edu)
# 3) Combine + FH fit + results + plots
#    Beides wurde über mun_res_cod gematcht und im Fay–Herriot-Modell geschätzt.
#    visualisiert mit Plots
# 4) Ergebnis:
#             Dadurch bekommt man stabile SAE-Schätzer pro Municipio sowie MSE/CV
#             + Möglichkeit die Shrinkage gegen Direct visualisieren.
#Für einen Sauberen Start:
#rm(list = ls())
# Packages ---------------------------------------------------------------
library(data.table)
library(dplyr)
library(emdi)
---
#########################################################################
# AREA-LEVEL SAE (Fay–Herriot) - FULL PIPELINE
# 1) Sample -> direct estimates (Mean) + sampling variance (Var_Mean)
#    das heißt aus dem Sample Datensatz habe ich pro Municipio den direkten Schätzer
#    und seine Varianz gebaut
# 2) Census -> auxiliary X (mean_years_edu) per municipio
#    Aus dem Census habe ich die Area-Level-Hilfsvariable (Kovariate) gebaut (mean_years_edu)
# 3) Combine + FH fit + results + plots
#    Beides wurde über mun_res_cod gematcht und im Fay–Herriot-Modell geschätzt.
#    visualisiert mit Plots
# 4) Ergebnis:
#             Dadurch bekommt man stabile SAE-Schätzer pro Municipio sowie MSE/CV
#             + Möglichkeit die Shrinkage gegen Direct visualisieren.
#Für einen Sauberen Start:
#rm(list = ls())
# Packages ---------------------------------------------------------------
library(data.table)
---
#########################################################################
# AREA-LEVEL SAE (Fay–Herriot) - FULL PIPELINE
# 1) Sample -> direct estimates (Mean) + sampling variance (Var_Mean)
#    das heißt aus dem Sample Datensatz habe ich pro Municipio den direkten Schätzer
#    und seine Varianz gebaut
# 2) Census -> auxiliary X (mean_years_edu) per municipio
#    Aus dem Census habe ich die Area-Level-Hilfsvariable (Kovariate) gebaut (mean_years_edu)
# 3) Combine + FH fit + results + plots
#    Beides wurde über mun_res_cod gematcht und im Fay–Herriot-Modell geschätzt.
#    visualisiert mit Plots
# 4) Ergebnis:
#             Dadurch bekommt man stabile SAE-Schätzer pro Municipio sowie MSE/CV
#             + Möglichkeit die Shrinkage gegen Direct visualisieren.
install.packages("data.table")
---
#########################################################################
# AREA-LEVEL SAE (Fay–Herriot) - FULL PIPELINE
# 1) Sample -> direct estimates (Mean) + sampling variance (Var_Mean)
#    das heißt aus dem Sample Datensatz habe ich pro Municipio den direkten Schätzer
#    und seine Varianz gebaut
# 2) Census -> auxiliary X (mean_years_edu) per municipio
#    Aus dem Census habe ich die Area-Level-Hilfsvariable (Kovariate) gebaut (mean_years_edu)
# 3) Combine + FH fit + results + plots
#    Beides wurde über mun_res_cod gematcht und im Fay–Herriot-Modell geschätzt.
#    visualisiert mit Plots
# 4) Ergebnis:
#             Dadurch bekommt man stabile SAE-Schätzer pro Municipio sowie MSE/CV
#             + Möglichkeit die Shrinkage gegen Direct visualisieren.
install.packages("data.table")
install.packages("data.table")
---
#########################################################################
# AREA-LEVEL SAE (Fay–Herriot) - FULL PIPELINE
# 1) Sample -> direct estimates (Mean) + sampling variance (Var_Mean)
#    das heißt aus dem Sample Datensatz habe ich pro Municipio den direkten Schätzer
#    und seine Varianz gebaut
# 2) Census -> auxiliary X (mean_years_edu) per municipio
#    Aus dem Census habe ich die Area-Level-Hilfsvariable (Kovariate) gebaut (mean_years_edu)
# 3) Combine + FH fit + results + plots
#    Beides wurde über mun_res_cod gematcht und im Fay–Herriot-Modell geschätzt.
#    visualisiert mit Plots
# 4) Ergebnis:
#             Dadurch bekommt man stabile SAE-Schätzer pro Municipio sowie MSE/CV
#             + Möglichkeit die Shrinkage gegen Direct visualisieren.
#Für einen Sauberen Start:
#rm(list = ls())
# Packages ---------------------------------------------------------------
library(data.table)
library(dplyr)
library(emdi)
# Paths ------------------------------------------------------------------
# Paths anpassen:
PATH_SAMPLE_RDS  <- "../../data_raw/sample/sample_for_model_building.RDS"
PATH_CENSUS_PER  <- "../../data_raw/large_files/Persona_CPV-2024.csv"
# C:\Users\nikla\OneDrive\Dokumente\GitHub\SAE_WS25\data_raw
# 0) Load SAMPLE (Survey) ------------------------------------------------
smp <- readRDS(PATH_SAMPLE_RDS)
# check: ob die benötigte Spalten im Sample da sind
stopifnot(all(c("mun_res_cod", "ocu_1d_19") %in% names(smp)))
# Domain-ID & Outcome sauber setzen
smp <- smp %>%
mutate(
mun_res_cod = as.character(mun_res_cod),
ocu_1d_19   = as.numeric(ocu_1d_19)
)
# 1) Direct estimates + vardir (aus dem Sample) --------------------------
# Ziel: pro municipio d
#   Mean_d = direkter Schätzer (z.B. Anteil beschäftigt)
#   Var_Mean_d = approximierte Varianz des direkten Schätzers
direct_estimates <- smp %>%
group_by(mun_res_cod) %>%
summarise(
Mean  = mean(ocu_1d_19, na.rm = TRUE),
n_eff = sum(!is.na(ocu_1d_19)),
Var_Mean = ifelse(n_eff > 0, Mean * (1 - Mean) / n_eff, NA_real_),
.groups = "drop"
)
# Stabilität: keine 0/NA Varianzen zulassen (FH braucht >0)
eps <- 1e-8
direct_estimates <- direct_estimates %>%
mutate(
Var_Mean = ifelse(is.na(Var_Mean), NA_real_, pmax(Var_Mean, eps))
)
# 2) Load CENSUS (Population) --------------------------------------------
# select da datensatz sehr groß
# für X_d braucht man hier nur mun_res_cod + aestudio.
census_person <- fread(
PATH_CENSUS_PER,
select = c("mun_res_cod", "aestudio")
)
# Check: Spalten da?
stopifnot(all(c("mun_res_cod", "aestudio") %in% names(census_person)))
# 3) Census auxiliary variable auf Area-Level ----------------------------
# years_edu aus aestudio, dann mean_years_edu pro municipio
census_person <- census_person %>%
mutate(
mun_res_cod = as.character(mun_res_cod),
years_edu   = suppressWarnings(as.numeric(as.character(aestudio)))
)
mun_res_cod
census_aux_data <- census_person %>%
group_by(mun_res_cod) %>%
summarise(
mean_years_edu = mean(years_edu, na.rm = TRUE),
.groups = "drop"
)
# 3a) !!!!!!!!!! emdi::fh erlaubt KEINE NAs in Aux-Variablen darum :
# Falls einzelne municipios komplett missing sind -> imputiere global mean
global_mean_edu <- mean(census_aux_data$mean_years_edu, na.rm = TRUE)
census_aux_data <- census_aux_data %>%
mutate(
mean_years_edu = ifelse(is.na(mean_years_edu), global_mean_edu, mean_years_edu)
)
stopifnot(!any(is.na(census_aux_data$mean_years_edu)))
# 4) Combine sample + census aux -----------------------------------------
# pop_data: alle Domains + X_d
# smp_data: Domains + direct + vardir
combined_data <- combine_data(
pop_data = as.data.frame(census_aux_data),
pop_domains = "mun_res_cod",
smp_data = as.data.frame(direct_estimates),
smp_domains = "mun_res_cod"
)
# 5) Fit Fay–Herriot model -----------------------------------------------
# Model: Mean_d = beta0 + beta1 * mean_years_edu_d + u_d + e_d
# e_d Var = Var_Mean_d
fh_fit <- fh(
fixed = Mean ~ mean_years_edu,
vardir = "Var_Mean",
combined_data = combined_data,
domains = "mun_res_cod",
method = "reml",   # meist Standard; "ml" geht auch
MSE = TRUE
)
# 6) Ergebnisse / Diagnose -----------------------------------------------
summary(fh_fit)
# FH vs Direct (Shrinkage sichtbar)
compare_plot(fh_fit, CV = TRUE, label = "no_title")
# Domain-Schätzer extrahieren
res <- estimators(fh_fit, MSE = TRUE, CV = TRUE)
# ============================================================
# AREA-LEVEL SAE (Fay–Herriot) - FULL PIPELINE
# ============================================================
#Für einen Sauberen Start:
rm(list = ls())
# Packages ----------------------------------------------------
library(data.table)
library(dplyr)
library(emdi)
# Mapping packages --------------------------------------------
library(sf)
library(ggplot2)
library(rvest)
library(stringi)
# Paths -------------------------------------------------------
# Wichtig: Pfade als Strings!
PATH_SAMPLE_RDS <- "../../data_raw/sample/sample_for_model_building.RDS"
PATH_CENSUS_PER <- "../../data_raw/large_files/Persona_CPV-2024.csv"
PATH_SHAPEFILE  <- "../../data_raw/shape/stanford-xg218hn4313-shapefile/xg218hn4313.shp"
# 0) Load SAMPLE (Survey) -------------------------------------
smp <- readRDS(PATH_SAMPLE_RDS)
# Check: benötigte Spalten vorhanden?
stopifnot(all(c("mun_res_cod", "ocu_1d_19") %in% names(smp)))
# Domain-ID & Outcome sauber setzen ---------------------------
<!-- smp <- smp %>% -->
# 1) Direct estimates + vardir (aus dem Sample) ----------------
# Ziel: pro municipio
#   Mean     = direkter Schätzer (z.B. Anteil beschäftigt)
#   Var_Mean = Approx.-Varianz des direkten Schätzers (Binomial)
direct_estimates <- smp %>%
group_by(mun_res_cod) %>%
summarise(
Mean     = mean(ocu_1d_19, na.rm = TRUE),
n_eff    = sum(!is.na(ocu_1d_19)),
Var_Mean = ifelse(n_eff > 0, Mean * (1 - Mean) / n_eff, NA_real_),
.groups  = "drop"
)
# Stabilität: FH braucht Varianz > 0 ---------------------------
eps <- 1e-8
direct_estimates <- direct_estimates %>%
mutate(
Var_Mean = ifelse(is.na(Var_Mean), NA_real_, pmax(Var_Mean, eps))
)
# 2) Load CENSUS (Population) ---------------------------------
# Nur die Spalten laden, die du brauchst
census_person <- fread(
PATH_CENSUS_PER,
select = c("mun_res_cod", "aestudio")
)
stopifnot(all(c("mun_res_cod", "aestudio") %in% names(census_person)))
# 3) Census auxiliary variable auf Area-Level ------------------
census_person <- census_person %>%
mutate(
mun_res_cod = as.character(mun_res_cod),
years_edu   = suppressWarnings(as.numeric(as.character(aestudio)))
)
census_aux_data <- census_person %>%
group_by(mun_res_cod) %>%
summarise(
mean_years_edu = mean(years_edu, na.rm = TRUE),
.groups = "drop"
)
# emdi::fh erlaubt keine NAs in Aux-Variablen -------------------
global_mean_edu <- mean(census_aux_data$mean_years_edu, na.rm = TRUE)
census_aux_data <- census_aux_data %>%
mutate(
mean_years_edu = ifelse(is.na(mean_years_edu), global_mean_edu, mean_years_edu)
)
stopifnot(!any(is.na(census_aux_data$mean_years_edu)))
# 4) Combine sample + census aux --------------------------------
combined_data <- combine_data(
pop_data    = as.data.frame(census_aux_data),
pop_domains = "mun_res_cod",
smp_data    = as.data.frame(direct_estimates),
smp_domains = "mun_res_cod"
)
# 5) Fit Fay–Herriot model -------------------------------------
fh_fit <- fh(
fixed         = Mean ~ mean_years_edu,
vardir        = "Var_Mean",
combined_data = combined_data,
domains       = "mun_res_cod",
method        = "reml",
MSE           = TRUE
)
summary(fh_fit)
# FH vs Direct (Shrinkage sichtbar) -----------------------------
compare_plot(fh_fit, CV = TRUE, label = "no_title")
# Domain-Schätzer extrahieren ----------------------------------
res <- estimators(fh_fit, MSE = TRUE, CV = TRUE)
# Domain-Spalte robust auf "Domain" vereinheitlichen ------------
if ("mun_res_cod" %in% names(res_df)) {
res_df <- rename(res_df, Domain = mun_res_cod)
} else if ("domains" %in% names(res_df)) {
res_df <- rename(res_df, Domain = domains)
} else if ("domain" %in% names(res_df)) {
res_df <- rename(res_df, Domain = domain)
} else if (!"Domain" %in% names(res_df)) {
stop("Keine Domain-Spalte in `res` gefunden.")
}
# 1) Direct estimates + vardir (aus dem Sample) ----------------
# Ziel: pro municipio
#   Mean     = direkter Schätzer (z.B. Anteil beschäftigt)
#   Var_Mean = Approx.-Varianz des direkten Schätzers (Binomial)
direct_estimates <- smp %>%
group_by(mun_res_cod) %>%
summarise(
Mean     = mean(ocu_1d_19, na.rm = TRUE),
n_eff    = sum(!is.na(ocu_1d_19)),
Var_Mean = ifelse(n_eff > 0, Mean * (1 - Mean) / n_eff, NA_real_),
.groups  = "drop"
)
# Domain-ID & Outcome sauber setzen ---------------------------
smp <- smp %>%
mutate(
mun_res_cod = as.character(mun_res_cod),
ocu_1d_19   = as.numeric(ocu_1d_19)
)
# 0) Load SAMPLE (Survey) -------------------------------------
smp <- readRDS(PATH_SAMPLE_RDS)
# 0) Load SAMPLE (Survey) -------------------------------------
smp <- readRDS(PATH_SAMPLE_RDS)
# ============================================================
# AREA-LEVEL SAE (Fay–Herriot) - FULL PIPELINE
# ============================================================
#Für einen Sauberen Start:
rm(list = ls())
# Packages ----------------------------------------------------
library(data.table)
library(dplyr)
library(emdi)
# Mapping packages --------------------------------------------
library(sf)
library(ggplot2)
library(rvest)
library(stringi)
# Paths -------------------------------------------------------
# Wichtig: Pfade als Strings!
PATH_SAMPLE_RDS <- "../../data_raw/sample/sample_for_model_building.RDS"
PATH_CENSUS_PER <- "../../data_raw/large_files/Persona_CPV-2024.csv"
PATH_SHAPEFILE  <- "../../data_raw/shape/stanford-xg218hn4313-shapefile/xg218hn4313.shp"
# 0) Load SAMPLE (Survey) -------------------------------------
smp <- readRDS(PATH_SAMPLE_RDS)
install.packages("here")
# Packages ----------------------------------------------------
library(data.table)
library(dplyr)
library(emdi)
library(here)
```{r}
# Paths -------------------------------------------------------
# Wichtig: Pfade als Strings!
PATH_SAMPLE_RDS <- "../../data_raw/sample/sample_for_model_building.RDS"
PATH_CENSUS_PER <- "../../data_raw/large_files/Persona_CPV-2024.csv"
PATH_SHAPEFILE  <- "../../data_raw/shape/stanford-xg218hn4313-shapefile/xg218hn4313.shp"
# 0) Load SAMPLE (Survey) -------------------------------------
smp <- readRDS(PATH_SAMPLE_RDS)
# Paths -------------------------------------------------------
# Wichtig: Pfade als Strings!
PATH_SAMPLE_RDS <- here::here("data_raw", "samples", "sample_for_model_building.RDS")
PATH_CENSUS_PER <- "../../data_raw/large_files/Persona_CPV-2024.csv"
PATH_SHAPEFILE  <- "../../data_raw/shape/stanford-xg218hn4313-shapefile/xg218hn4313.shp"
# 0) Load SAMPLE (Survey) -------------------------------------
smp <- readRDS(PATH_SAMPLE_RDS)
# Check: benötigte Spalten vorhanden?
stopifnot(all(c("mun_res_cod", "ocu_1d_19") %in% names(smp)))
# Domain-ID & Outcome sauber setzen ---------------------------
smp <- smp %>%
mutate(
mun_res_cod = as.character(mun_res_cod),
ocu_1d_19   = as.numeric(ocu_1d_19)
)
# 1) Direct estimates + vardir (aus dem Sample) ----------------
# Ziel: pro municipio
#   Mean     = direkter Schätzer (z.B. Anteil beschäftigt)
#   Var_Mean = Approx.-Varianz des direkten Schätzers (Binomial)
direct_estimates <- smp %>%
group_by(mun_res_cod) %>%
summarise(
Mean     = mean(ocu_1d_19, na.rm = TRUE),
n_eff    = sum(!is.na(ocu_1d_19)),
Var_Mean = ifelse(n_eff > 0, Mean * (1 - Mean) / n_eff, NA_real_),
.groups  = "drop"
)
# Stabilität: FH braucht Varianz > 0 ---------------------------
eps <- 1e-8
direct_estimates <- direct_estimates %>%
mutate(
Var_Mean = ifelse(is.na(Var_Mean), NA_real_, pmax(Var_Mean, eps))
)
# 2) Load CENSUS (Population) ---------------------------------
# Nur die Spalten laden, die du brauchst
census_person <- fread(
PATH_CENSUS_PER,
select = c("mun_res_cod", "aestudio")
)
class(smp)
dim(smp)
names(smp)
str(smp)
summary(smp)
census_aux_data <- census_person %>%
group_by(mun_res_cod) %>%
summarise(
mean_years_edu = mean(years_edu, na.rm = TRUE),
.groups = "drop"
)
# 3) Census auxiliary variable auf Area-Level ------------------
census_person <- census_person %>%
mutate(
mun_res_cod = as.character(mun_res_cod),
years_edu   = suppressWarnings(as.numeric(as.character(aestudio)))
)
census_aux_data <- census_person %>%
group_by(mun_res_cod) %>%
summarise(
mean_years_edu = mean(years_edu, na.rm = TRUE),
.groups = "drop"
)
# emdi::fh erlaubt keine NAs in Aux-Variablen -------------------
global_mean_edu <- mean(census_aux_data$mean_years_edu, na.rm = TRUE)
census_aux_data <- census_aux_data %>%
mutate(
mean_years_edu = ifelse(is.na(mean_years_edu), global_mean_edu, mean_years_edu)
)
stopifnot(!any(is.na(census_aux_data$mean_years_edu)))
# 4) Combine sample + census aux --------------------------------
combined_data <- combine_data(
pop_data    = as.data.frame(census_aux_data),
pop_domains = "mun_res_cod",
smp_data    = as.data.frame(direct_estimates),
smp_domains = "mun_res_cod"
)
# 5) Fit Fay–Herriot model -------------------------------------
fh_fit <- fh(
fixed         = Mean ~ mean_years_edu,
vardir        = "Var_Mean",
combined_data = combined_data,
domains       = "mun_res_cod",
method        = "reml",
MSE           = TRUE
)
summary(fh_fit)
# FH vs Direct (Shrinkage sichtbar) -----------------------------
compare_plot(fh_fit, CV = TRUE, label = "no_title")
# Domain-Spalte robust auf "Domain" vereinheitlichen ------------
if ("mun_res_cod" %in% names(res_df)) {
res_df <- rename(res_df, Domain = mun_res_cod)
} else if ("domains" %in% names(res_df)) {
res_df <- rename(res_df, Domain = domains)
} else if ("domain" %in% names(res_df)) {
res_df <- rename(res_df, Domain = domain)
} else if (!"Domain" %in% names(res_df)) {
stop("Keine Domain-Spalte in `res` gefunden.")
}
# Domain-Schätzer extrahieren ----------------------------------
res <- estimators(fh_fit, MSE = TRUE, CV = TRUE)
res_df <- as.data.frame(res)
# Domain-Spalte robust auf "Domain" vereinheitlichen ------------
if ("mun_res_cod" %in% names(res_df)) {
res_df <- rename(res_df, Domain = mun_res_cod)
} else if ("domains" %in% names(res_df)) {
res_df <- rename(res_df, Domain = domains)
} else if ("domain" %in% names(res_df)) {
res_df <- rename(res_df, Domain = domain)
} else if (!"Domain" %in% names(res_df)) {
stop("Keine Domain-Spalte in `res` gefunden.")
}
# Schätzer-Spalten robust standardisieren -----------------------
nms_lower <- tolower(names(res_df))
if ("direct" %in% nms_lower) names(res_df)[match("direct", nms_lower)] <- "Direct"
if ("fh"     %in% nms_lower) names(res_df)[match("fh",     nms_lower)] <- "FH"
if ("mse"    %in% nms_lower) names(res_df)[match("mse",    nms_lower)] <- "MSE"
if ("cv"     %in% nms_lower) names(res_df)[match("cv",     nms_lower)] <- "CV"
res_df <- res_df %>%
mutate(
Domain = as.character(Domain),
FH     = as.numeric(FH)
)
# ============================================================
# MAPPING
# ============================================================
# 0) Shapefile laden -------------------------------------------
bol_muni <- st_read(PATH_SHAPEFILE) %>%
mutate(
name_key = stri_trans_general(toupper(trimws(name_3)), "Latin-ASCII")
)
# 1) Wikipedia-Tabelle: INE-Code -> Municipio-Name --------------
wiki_url <- "https://es.wikipedia.org/wiki/Anexo:Municipios_de_Bolivia"
tables <- read_html(wiki_url) %>% html_table(fill = TRUE)
mun_table <- tables[[1]]
crosswalk <- mun_table %>%
transmute(
Domain    = as.character(`Código INE`),
muni_name = as.character(Nombre)
) %>%
mutate(
name_key = stri_trans_general(toupper(trimws(muni_name)), "Latin-ASCII")
) %>%
distinct(Domain, name_key)
# 2) SAE-Ergebnisse vorbereiten --------------------------------
sae_res <- res_df %>%
transmute(
Domain = as.character(Domain),
sae    = as.numeric(FH)
) %>%
filter(Domain != "0", Domain != "999999")
# 3) Join: Shape -> Wikipedia -> SAE ----------------------------
map_df <- bol_muni %>%
left_join(crosswalk, by = "name_key") %>%
left_join(sae_res,   by = "Domain")
sum(!is.na(map_df$sae))
# 4) Plot -------------------------------------------------------
ggplot(map_df) +
geom_sf(aes(fill = sae), color = NA) +
scale_fill_viridis_c(na.value = "grey90") +
labs(
title    = "Bolivien – Fay–Herriot Small Area Estimation (Municipios)",
subtitle = "Join über Municipio-Namen (Shape) + INE-Codes (Wikipedia)",
fill     = "FH-Schätzer"
) +
theme_minimal()
##Census neu einlesen (für Kovariat suche)
```{r}
census_person <- fread(PATH_CENSUS_PER)
#Alter – p26_edad  (mean_age_d = Durchschnittsalter im Municipio)
Geschlecht – p25_sexo  (share_female_d = Anteil Frauen im Municipio)
# ============================================================
# AREA-LEVEL SAE (Fay–Herriot) - FULL PIPELINE
# ============================================================
#Für einen Sauberen Start:
rm(list = ls())
load("C:/Users/nikla/OneDrive/Dokumente/GitHub/SAE_WS25/syntax/niklas/.RData")

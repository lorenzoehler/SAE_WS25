---
title: "Preprocess"
author: "Lorenz & Niklas"
output:
  html_document:
    theme: flatly      
    toc: true          
    toc_float: true    
    toc_depth: 4       
    highlight: tango   
    df_print: paged    
    css: styles.css 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message=FALSE, warning=FALSE}
library(data.table)
library(tidyverse)
```

# Introduction

In this document we want to 
- take a look at the census data set
- figure out a way of opening and manipulating the whole dataset
- leave a merged data set, which is a little bit easier to handle

# Preprocessing

## Loading Data


```{r}
### Houshold
dat_houshold <- fread("../data_raw/large_files/Vivienda_CPV-2024.csv")
dat_houshold[1:5.,1:7]
```


```{r}
### Person
dat_person <- fread("../data_raw/large_files/Persona_CPV-2024.csv")
```

### uknown locations in mun_res_cod
This part is a little bit of a tangent, because we were not sure which variable to use for creating the matching IDs to map the Domains to the shape file.     

no value in either the iprov, idep or imun should be 99
```{r}
### number of nas for the colums idep, iprov, imun
dat_person %>% select(idep, iprov, imun) %>%
  summarise(across(everything(), ~ sum(is.na(.))))

```
no NA for these rows

```{r}
tmp_table <- dat_person[dat_person$mun_res_cod == c(0,99999,999999), c("idep","iprov","imun","mun_res_cod")]

### how many have i.e a 0, 99999 or 999999 
tmp_table %>% filter(mun_res_cod == 0|mun_res_cod == 99999|mun_res_cod == 999999)
tmp_table$mun_res_cod %>% table()
```

Thus we will not use mun_res_cod as a variable to identify location, because we have the other option with not NA or 99 values.   

Of interest would be, why some of the individuals have missing values for mun_res_cod, but have values for the idep,iprov and imun, but this is too much work for the project, thus we will just use the iXXX columns to identify the location.

## Creating IDs 

```{r}
dat_person$ID_mun <- paste0("BO",
  sprintf("%02.0f", dat_person$idep),
  sprintf("%02.0f", dat_person$iprov),
  sprintf("%02.0f", dat_person$imun))

### create ID for Province
dat_person$ID_prov <- paste0("BO",
  sprintf("%02.0f", dat_person$idep),
  sprintf("%02.0f", dat_person$iprov))
```


# Selection 

## Filter Age
Because we are working with the concept of years of education, it makes sense to not use  all of the people, we are restricting the sample to the ones above the age of 18.  

```{r}
### only above 18
dat_person <- dat_person %>% filter(p26_edad >= 18)
```

# Merging Person and Houshold 
The houshold data is in a separate data frame. Mergin the houshold data with the person data, requires only the i00 column. 

```{r}
## removing first three rows to not have duplets
dat_houshold <- dat_houshold %>% select(-idep,-iprov,-imun)

## merging
dat <- merge(dat_person,dat_houshold, by = "i00")

### save 
saveRDS(dat,"../data_raw/large_files/dat_preprocessing-01.RDS")
```

# Draw sample for Model Specification
```{r}
dat <- readRDS("../data_raw/large_files/dat_preprocessing-01.RDS")
set.seed(420)
dat <- dat[!is.na(dat$aestudio),]

dat_sampling <- data.frame(
  "row" = 1:nrow(dat),
  "ID_prov" = dat$ID_prov
)
  

### first smaple for modeling
list <- dat_sampling %>%
  group_by(ID_prov) %>%
  slice_sample(n = 20) %>%
  ungroup()

# sample <- dat[list$row,]
# sample$aestudio %>% is.na() %>% table()

## save the sampling for model building
# saveRDS(sample,"../data_raw/samples/sample_for_model_building.RDS")
```



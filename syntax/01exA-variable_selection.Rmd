---
title: "Variable Selection"
author: "Lorenz Alban Oehler"
date: "The Date"
output:
  html_document:
    theme: flatly      
    toc: true          
    toc_float: true    
    toc_depth: 4       
    highlight: tango   
    df_print: paged    
    css: styles.css 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Purpose
This script serves as a playing ground to figure out which variables serve best to build a good model, to predict our dependend variable. 

```{r message=FALSE, warning=FALSE}
remove(list = ls())
library(reactable)
library(sf)
library(data.table)
library(tidyverse)
library(corrplot)
library(reshape2)
library(igraph)
library(psych)
library(openxlsx)
```

```{r}
sample <- readRDS("../data_raw/samples/sample_for_model_building.RDS")
ncol(sample) ### abzügzlich der 5 nicht inhaltlichen Variablen
```

```{r}
## how many colums are there
sample %>% dim()
```

```{r}
sample <- sample %>% as.data.frame()

### delete administrative variables
tmp_variable <- c("i00","idep","iprov","imun","ID_mun","ID_prov")
sample <- sample[,!colnames(sample) %in% tmp_variable]
```

we have 164 variables, minus the 5 "administrative" ones results in 159 variables 

# Selection

## Filter NAs
filter for variables which have lots of NAs 

```{r}
dat_table_nas <- tibble(
  "colnames" = colnames(sample),
  "pecentageNAs" = sapply(
    sample,
    FUN = function(x)
      round(mean(is.na(x)), 3)
  )
)

hist(dat_table_nas$pecentageNAs,breaks = 40)
reactable(dat_table_nas,filterable = T,compact = T,defaultPageSize = 15)
```

because we need values to actually contain information we will only take a look at the variables, that have at least 50% not NA

```{r}
### leads to deletion of 
(dat_table_nas$pecentageNAs > .5) %>% sum()

## how many 
dat_selection <- dat_table_nas %>% filter(pecentageNAs < .5)
```

# Model With Single Predictor
In the next step i will run just a single model to get a rough idea of how well two variables are connected and could be used for prediction

Because of simplicity I will just ran a numeric and factorial model for each variable. I will exclude the variables which have way to many levels (over 500).
This loop either jumps the variable, if the variable only has 1 level or over 500.


```{r}
list_variables <- dat_selection$colnames

dat_ko_variables <- data_frame(
  "variable" = character(),
  "r_squared_num" = character(),
  "p_value_num" = character(),
  "r_squared_factor" = character(),
  "p_value_factor" = character(),
  "n_fac_lelves" = character(),
  "min" = character(),
  "qnt_1st" = character(),
  "median" = character(),
  "mean" = character(),
  "qnt_3rd" = character(),
  "max" = character(),
  "NA_percentage" = character()
)

for (i in 1:length(list_variables)) {
  tmp_object <- list_variables[i]
  tmp_variable_num <- sample[[tmp_object]]
  tmp_variable_fac <- tmp_variable_num %>% as.factor()
  tmp_length_variable <- table(tmp_variable_fac) %>% length()
  
  print(paste0("now doing number: ", i))
  
  ### dont run model if more then 15 factor
  if (tmp_length_variable > 500) {
    tmp_data <- data_frame(
      "variable" = tmp_object,
      "r_squared_num" = NA,
      "p_value_num" = NA,
      "r_squared_factor" = NA,
      "p_value_factor" = NA,
      "n_fac_lelves" = tmp_length_variable,
      "min" = summary(tmp_variable_num)[1],
      "qnt_1st" = summary(tmp_variable_num)[2],
      "median" = summary(tmp_variable_num)[3],
      "mean" = summary(tmp_variable_num)[4],
      "qnt_3rd" = summary(tmp_variable_num)[5],
      "max" = summary(tmp_variable_num)[6],
      "NA_percentage" = mean(is.na(tmp_variable_num))
    )
    
    dat_ko_variables <- rbind(dat_ko_variables, tmp_data)
    print("early exit, too many")
    next
    
  } else if (tmp_length_variable <= 1) {
    tmp_data <- data_frame(
      "variable" = tmp_object,
      "r_squared_num" = NA,
      "p_value_num" = NA,
      "r_squared_factor" = NA,
      "p_value_factor" = NA,
      "n_fac_lelves" = tmp_length_variable,
      "min" = summary(tmp_variable_num)[1],
      "qnt_1st" = summary(tmp_variable_num)[2],
      "median" = summary(tmp_variable_num)[3],
      "mean" = summary(tmp_variable_num)[4],
      "qnt_3rd" = summary(tmp_variable_num)[5],
      "max" = summary(tmp_variable_num)[6],
      "NA_percentage" = mean(is.na(tmp_variable_num))
    )
    
    dat_ko_variables <- rbind(dat_ko_variables, tmp_data)
    print("early exit, one or less")
    next
    
  } else {
    formula <- as.formula(paste("aestudio ~", tmp_object))
    model_num <- lm(sample$aestudio ~ tmp_variable_num)
    model_fac <- lm(sample$aestudio ~ tmp_variable_fac)
    
    r_squared_num <- summary(model_num)$r.squared
    p_value_num <- summary(model_num)$coefficients[1, 4]
    
    r_squared_factor <- summary(model_fac)$r.squared
    p_value_factor <- summary(model_fac)$coefficients[1, 4]

    tmp_data <- data_frame(
      "variable" = tmp_object,
      "r_squared_num" = r_squared_num,
      "p_value_num" = p_value_num,
      "r_squared_factor" = r_squared_factor,
      "p_value_factor" = p_value_factor,
      "n_fac_lelves" = tmp_length_variable,
      "min" = summary(tmp_variable_num)[1],
      "qnt_1st" = summary(tmp_variable_num)[2],
      "median" = summary(tmp_variable_num)[3],
      "mean" = summary(tmp_variable_num)[4],
      "qnt_3rd" = summary(tmp_variable_num)[5],
      "max" = summary(tmp_variable_num)[6],
      "NA_percentage" = mean(is.na(tmp_variable_num))
    )
    dat_ko_variables <- rbind(dat_ko_variables, tmp_data)
  }
}

```

```{r}
## convert column to numeric
dat_ko_variables$mean <- dat_ko_variables$mean %>% as.numeric() 

### round variables to 3 digits after 0 
dat_ko_variables <- dat_ko_variables %>%
  mutate(across(where(is.numeric), ~ round(.x, 3)))

dat_ko_variables %>% reactable(.,compact = T, filterable = T,defaultPageSize = 20)
```

```{r}
dat_ko_variables <- dat_ko_variables[order(dat_ko_variables$r_squared_factor,decreasing = T),]
```

## save as excel
For exploratory purposes I will export the data frame as an excel.   
An older version of this exists which was used to select the variables, it has the suffix _filled. 

```{r}
write.xlsx(dat_ko_variables,"../data_raw/2024_census/processed/dat_ko_variables_selection.xlsx")
```

# combined model

```{r}
## remove aestudio
dat_ko_variables_selection <- dat_ko_variables %>% dplyr::filter(variable != "aestudio")

### remove variables with high fac levels
(dat_ko_variables_selection$n_fac_lelves >= 15) %>% sum()
dat_ko_variables_selection <- dat_ko_variables_selection[dat_ko_variables_selection$n_fac_lelves < 15,]

# ### remove variables with high NA-ratio
# (dat_ko_variables_selection$NA_percentage > .25) %>% sum()
# dat_ko_variables_selection <- dat_ko_variables_selection[dat_ko_variables_selection$NA_percentage < .25,]

### remove variables, which are too close conceptually
dat_ko_variables_selection <- dat_ko_variables_selection %>% filter(!variable %in%  c("p41a_nivel","p41b_curso","p41a_nivel_act","p41b_curso_act","nivel_edu","p38_asiste", "asiste"))
```

# Cramers V 
```{r}

sample$aestudio %>% is.na() %>% table()
sample <- sample %>% as.data.frame()


### filter with factors over 15
idx <- sapply(sample,FUN = function(x) length(unique(x)) > 15)
idx %>% table()
sample2 <- sample[, !idx]

### filter with na percentage higher then .5
idx <- sapply(sample2,FUN = function(x) mean(is.na(x)) > .5)
idx %>% table()
sample2 <-  sample2[, !idx]

### other non informative variables filter 
sample2 <- sample2[,!colnames(sample2) %in% c("idep","imun")]

sample_fast <- data.frame(lapply(sample2, function(x) {
  if (is.factor(x)) as.numeric(x) else x
}))

sample2

library(vcd)

tmp_data <- matrix(ncol = 3,nrow = 0) %>% as.data.frame()
colnames(tmp_data) <- c("v1","v2","cramresV")

for(i in seq_along(sample2)){
  for(j in seq_along(sample2)){
  x1 <- sample2[,i] %>% as.factor()
  x2 <- sample2[,j] %>% as.factor()
  tbl <- table(x1, x2)
  tmp_vec <- c(colnames(sample2)[i],colnames(sample2)[j],assocstats(tbl)$cramer[[1]]) %>% unlist()
  tmp_data <- rbind(tmp_data,tmp_vec)
    
  }
}

colnames(tmp_data) <- c("v1","v2","cramresV")
```

## Histogram

```{r}
tmp_data$cramresV <- tmp_data$cramresV %>% as.numeric
tmp_data$cramresV %>% hist()
```
This is a histogramm showing the distribution of the correlation between all variables. 

## Correlation Matrix

```{r}
cram_mat <- tmp_data %>%
  filter(v1 != v2) %>%                  # remove self-pairs
  pivot_wider(
    names_from  = v2,
    values_from = cramresV
  ) %>%
  column_to_rownames("v1") %>%
  as.matrix()

dim(cram_mat)
```


```{r corr_matrix,dev = "png",fig.width = 6,fig.height = 6,fig.path = "../output/",fig.ext = "png"}
corrplot(
  cram_mat,
  method = "color",
  type   = "lower",
  tl.cex = 0.6
)
```


```{r}
cram_long <- melt(cram_mat)

corr_matrix_2 <-  ggplot(cram_long, aes(Var1, Var2, fill = value)) +
  geom_tile() +
  scale_fill_viridis_c() +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1, size = 6),
    axis.text.y = element_text(size = 6)
  ) +
  labs(fill = "Cramér's V")

corr_matrix_2

ggsave("../output/corr_matrix-2.png",plot = corr_matrix_2,width = 10,height = 6, device = "png",dpi = 300)
```

```{r}
dat_selection <- tmp_data

### drop the pair with itself
dat_selection <- dat_selection[dat_selection$v1 != dat_selection$v2,]
dat_selection <- dat_selection[!is.na(dat_selection$cramresV),]
dat_selection$cramresV %>% hist()

dat_selection %>% reactable(.,compact = T,filterable = T)
```

```{r}
### load in list from. A
list_variables <- readRDS("../data_raw/misc/list_variables_seleciton.RDS")

### filter for only these variables
dat_selection <- dat_selection[dat_selection$v1 %in% list_variables,]

dat_selection$pair_sorted <- apply(dat_selection[, c("v1","v2")], 1, function(x) paste(sort(x), collapse = "_"))
dat_selection_unique <- dat_selection[!duplicated(dat_selection$pair_sorted), ]

dat_selection_unique[,1:3] %>% reactable(.,compact = T,filterable = T)
```

```{r}
# dat_selection_unique: v1, v2, cramresV
threshold <- 0.75

# keep only strong pairs
strong_pairs <- dat_selection_unique %>% filter(cramresV > threshold)

# build graph
g <- graph_from_data_frame(strong_pairs[, c("v1", "v2")], directed = FALSE)

# find connected components
comp <- components(g)

# create a dataframe with groups
group_df <- data.frame(
  var = names(comp$membership),
  group = comp$membership
)

# optional: collapse variables in each group into one row
grouped_vars <- group_df %>%
  group_by(group) %>%
  summarise(vars = paste(var, collapse = ", "), .groups = "drop")

reactable(grouped_vars)
```


```{r}
# how many covariats currently in there
dat_ko_variables_selection$variable %>% length()

dat_ko_variables_selection$variable
```


```{r}
### remove highly correlated items (9 gorups identified in script B)
# highly correlated with p28_cn, 
tmp_variables <- "p29_ci"
dat_ko_variables_selection <- dat_ko_variables_selection %>% filter(!variable %in% 
                                                                      tmp_variables)

# highly correlated with p30f_autome, 
tmp_variables <- "p30g_casera"
dat_ko_variables_selection <- dat_ko_variables_selection %>% filter(!variable %in% 
                                                                      tmp_variables)

# highly correlated with edad, 
tmp_variables <- c("g_edad","g_edad_bol","gedadedu")
dat_ko_variables_selection$variable %in% tmp_variables %>% sum()
dat_ko_variables_selection <- dat_ko_variables_selection %>% filter(!variable %in% 
                                                                      tmp_variables)

# highly correlated with pet_19, 
tmp_variables <- c("condact_19","pet_13","pea_13","condact_13","ft_19") ## condact_13 already filtered out
tmp_variables %in% dat_ko_variables_selection$variable %>% sum()
dat_ko_variables_selection <- dat_ko_variables_selection %>% filter(!variable %in% 
                                                                      tmp_variables)

# highly correlated with pet_19, 
tmp_variables <- c("condact_19","pet_13","pea_13","condact_13","ft_19") ### all of them already filtered out, only pet_19 in 
tmp_variables %in% dat_ko_variables_selection$variable %>% sum()
dat_ko_variables_selection <- dat_ko_variables_selection %>% filter(!variable %in% 
                                                                      tmp_variables)

# highly correlated with ocu_1d_13, 
tmp_variables <- c("p49_ocu_1d","ocu_1d_19") ### all already filtered out
tmp_variables %in% dat_ko_variables_selection$variable %>% sum()
dat_ko_variables_selection <- dat_ko_variables_selection %>% filter(!variable %in% 
                                                                      tmp_variables)

# highly correlated with p50_catocu_13, 
tmp_variables <- c("p50_semp") ### already filtered out
tmp_variables %in% dat_ko_variables_selection$variable %>% sum()
dat_ko_variables_selection <- dat_ko_variables_selection %>% filter(!variable %in% 
                                                                      tmp_variables)

# highly correlated with v18f_refri, 
tmp_variables <- c("v18g_micro","v18j_lavadora","v19c_compu","v19e_inetfijo","v19b_tv","v19g_tvcable")
tmp_variables %in% dat_ko_variables_selection$variable %>% sum()
dat_ko_variables_selection <- dat_ko_variables_selection %>% filter(!variable %in% 
                                                                      tmp_variables)

# highly correlated with v19d_celular, 
tmp_variables <- c("v19f_inetmovil","v19e_f","v19h_d")
tmp_variables %in% dat_ko_variables_selection$variable %>% sum()
dat_ko_variables_selection <- dat_ko_variables_selection %>% filter(!variable %in% 
                                                                      tmp_variables)

### remove because of singularity 
tmp_variables <- c("v02_condocup")
tmp_variables %in% dat_ko_variables_selection$variable %>% sum()
dat_ko_variables_selection <- dat_ko_variables_selection %>% filter(!variable %in% 
                                                                      tmp_variables)

### remove municipality codes 
tmp_variables <- c("dep_res_cod","dep_res5_cod","dep_lab_cod","dep_nac_cod") ### dep_lab_cod already out 
tmp_variables %in% dat_ko_variables_selection$variable %>% sum()
dat_ko_variables_selection <- dat_ko_variables_selection %>% filter(!variable %in% 
                                                                      tmp_variables)

candidates <- dat_ko_variables_selection[,"variable"]


sample <- sample %>% as.data.frame()
sample_candidates <- sample[,c("aestudio",candidates$variable) %in% colnames(sample)]

formula <- paste("aestudio ~",paste(c("p26_edad",candidates$variable),collapse =  " + " ))
formula <- formula %>% as.formula()
```

# Linear Models

```{r}
# sample$p332_idiohab2_cod[is.na(sample$p332_idiohab2_cod)] <- "Missing"
### replace all NAs with Missing, so its its own factor
## becase sample_candidates[,candidates$variable] %>% na.omit()
## in a big shrinkage of the data frame
sample_candidates[,candidates$variable][is.na(sample_candidates[,candidates$variable])] <- "Missing"

## convert all of them to factors 
for (col in candidates$variable) {
  sample_candidates[[col]] <- factor(sample_candidates[[col]])
}
lm(formula = formula,data = sample_candidates) %>% summary()
```

## Step-Wise-Regression: AIC
### Backward

```{r}
model_full <- lm(formula = formula,data = sample_candidates)
model_null <- lm(formula = aestudio ~ 1,data = sample_candidates)
# model_full %>% summary()

model_backward <- step(model_full,direction = "backward",trace = 0)
# model_backward %>% summary()
```


```{r}
model_forward <- step(model_null,scope = formula, direction = "forward", trace = 0)
# model_forward %>% summary()
```

```{r}
model_both <- step(model_null,scope = formula, direction = "both", trace = 0)
# model_both %>% summary()
```

```{r}
model_backward$call %>% print() 
model_forward$call %>% print() 
model_both$call %>% print() 
```

## Step-Wise-Regression: BIC
    
```{r}
model_backward_BIC <- step(model_full,direction = "backward",trace = 0, k = log(nrow(sample_candidates)))
# model_backward_BIC %>% summary()
```

```{r}
model_forward_BIC <- step(model_null,scope = formula, direction = "forward",trace = 0, k = log(nrow(sample_candidates)))
# model_forward_BIC %>% summary()
```

```{r}
model_both_BIC <- step(model_null,scope = formula, direction = "both", trace = 0,k =  log(nrow(sample_candidates)))
# model_both_BIC %>% summary()
```

```{r}
model_backward_BIC$call %>% print() 
model_forward_BIC$call %>% print() 
model_both_BIC$call %>% print() 
```
model_backward_BIC$call %>% print() 
model_forward_BIC$call %>% print() 
model_both_BIC$call %>% print() 

```{r}
# model_backward_BIC %>% summary()
# model_forward_BIC %>% summary()
# model_both_BIC %>% summary()

AIC(model_backward_BIC)
AIC(model_forward_BIC)
AIC(model_both_BIC)
```



```{r}
## covariats for the AIC 
covariates <- names(model_both$coefficients)
covariates <- covariates[covariates != "(Intercept)"]
covariates %>% length()
covariates


## covariats for the BIC 
covariates <- names(model_both_BIC$coefficients)
covariates <- covariates[covariates != "(Intercept)"]
covariates %>% length()
covariates

```




